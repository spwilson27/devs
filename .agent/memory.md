# Agent Long-Term Memory

This file serves as a shared, long-term memory for all agents working on this project. Agents should append to this document to record important architectural decisions, recurring issues, project-wide conventions, and any other crucial context that future tasks will benefit from.

## üèõÔ∏è Architectural Decisions
*Note overarching design choices, patterns, or project-wide conventions here.*

- **2026-02-20 - Initial Setup:** Started long-term memory to ensure agents pass architectural messages to one another. Agents should actively review and append to this doc when making meaningful structural changes.

- **2026-02-21 - pnpm Monorepo Structure (Phase 1, Task 01):** Established the pnpm v9+ monorepo with 7 packages under `packages/` scoped as `@devs/<name>`. Packages: `core`, `agents`, `sandbox`, `memory`, `mcp`, `cli`, `vscode`. Node.js >= 22 enforced via `.nvmrc` and root `package.json` `engines` field. `shamefully-hoist=false` enforced in `.npmrc` to prevent phantom dependencies.

- **2026-02-21 - TAS-096 Module Separation (Phase 1, Task 01):** `@devs/core` must NEVER depend on `@devs/sandbox`. This is a hard constraint enforced by the verification test (`tests/infrastructure/verify_monorepo.sh`). `@devs/sandbox` is strictly isolated. `@devs/core` has no workspace dependencies (only external libs). Consumers of `@devs/core`: `agents`, `mcp`, `cli`, `vscode`.

- **2026-02-21 - Headless-First Design (Phase 1, Task 01):** `@devs/cli` and `@devs/vscode` are UI shells only ‚Äî all business logic must live in `@devs/core`. This separation is intentional and must be maintained through all future phases.

- **2026-02-21 - `./do` Script Pattern:** The `./do` Python script is the project task runner. `./do build` runs `pnpm exec tsc --noEmit` (type check, no output). `./do test` runs `verify_monorepo.sh`, `verify_folder_structure.sh`, and `verify_typescript_strict.sh`. `fmt`, `lint`, and `coverage` remain stubs until real tools are configured in future phases.

- **2026-02-21 - TypeScript Strict Configuration (Phase 1, Task 02):** TypeScript 5.9.3 installed as root devDependency. Root `tsconfig.json`: `strict: true`, `target: ES2022`, `module: NodeNext`, `moduleResolution: NodeNext`, `esModuleInterop: true`, `forceConsistentCasingInFileNames: true`, `skipLibCheck: true`. Each package has `packages/<name>/tsconfig.json` extending `../../tsconfig.json` with `outDir: ./dist`, `rootDir: ./src`. Minimal `src/index.ts` stubs created per package for `tsc --noEmit` to work without errors. Authoritative documentation at `docs/infrastructure/typescript_standard.md`.

- **2026-02-21 - Root Directory Structure (Phase 1, Task 03):** Eight required top-level directories: `.devs/` (Flight Recorder/observability), `.agent/` (agent docs/memory), `mcp-server/` (MCP server entry), `src/` (root entry points), `tests/` (infra + integration tests), `docs/` (documentation), `scripts/` (admin scripts), `packages/` (monorepo packages). Authoritative description at `docs/architecture/directory_structure.md`.

- **2026-02-21 - Flight Recorder Design (Phase 1, Task 03):** `.devs/` is the Flight Recorder. SQLite (via `better-sqlite3`) and LanceDB (via `vectordb`) runtime state managed exclusively by `@devs/core` and `@devs/memory`. Developer Agents have NO write access to `.devs/` ‚Äî prevents state tampering and loop-counter manipulation. Runtime files are gitignored via `.devs/.gitignore`; only `POLICY.md` and `.gitignore` are tracked in VCS.

- **2026-02-21 - AOD (Agent-Oriented Documentation) Pattern (Phase 1, Task 04):** `.agent/packages/` mirrors `packages/` with one subdirectory per package. Two types of `.agent.md` files: (1) package-level overview at `.agent/packages/<pkg>/.agent.md` (not ratio-checked), (2) module-level docs at `.agent/packages/<pkg>/<path>/<module>.agent.md` (1:1 ratio with source). `scripts/aod_lint.py` enforces the ratio; `tests/infrastructure/verify_aod_ratio.sh` verifies the full infrastructure; `./do test` runs it. All `.agent.md` files must have YAML front-matter (machine-readable). Authoritative policy at `docs/infrastructure/aod_policy.md`.

- **2026-02-21 - Shared State Manifest & STATE_FILE_PATH (Phase 1, Task 05):** `STATE_FILE_PATH = ".devs/state.sqlite"` is the canonical constant defined in `packages/core/src/constants.ts`. All packages MUST import this constant ‚Äî never hardcode the path. `resolveStatePath(fromDir?)` and `findProjectRoot(dir)` in `packages/core/src/persistence.ts` resolve the absolute state path by walking up to the nearest `private: true` `package.json`. Root `package.json` now has a `devs` metadata field: `{ version: "1.0.0", status: "development", architecture: "monorepo" }`. State sharing documented at `docs/architecture/state_sharing.md`.

- **2026-02-21 - Scaffolding Utility (Phase 1, Task 06):** `scripts/scaffold_project.py` implements the `init-project <path>` command. Creates the full TAS-040/TAS-104 directory structure for any new devs project: `.devs/`, `.agent/`, `mcp-server/`, `src/`, `tests/`, `docs/`, `scripts/`, `.github/`. Root files: `.gitignore`, `.env.example`, `README.md`, `package.json` (with `devs.project_id` UUID, `devs.version`, `devs.generated_by`). AOD files: `.agent/index.agent.md`, `.agent/catalog.json`, `.agent/modules/`. Flight Recorder init: `.devs/.gitignore` (excludes `*.sqlite`, LanceDB, logs), `.devs/POLICY.md`. Safety: refuses non-empty target directories. Usage documented at `docs/usage/project_scaffolding.md`.

- **2026-02-21 - Vitest Unit Testing Setup (Phase 1, Task 06/01):** Vitest v4+ installed at root (`-w`) as the project-wide unit test runner. Config at `vitest.config.ts` (root); includes `packages/*/src/**/*.test.ts` and `packages/*/test/**/*.test.ts`. `./do test` now runs `pnpm exec vitest run` as the final step after infrastructure checks. Tests use `vi.mock()` for module mocking (equivalent to `jest.mock`). Test files (`.test.ts`) are excluded from the AOD 1:1 ratio check by `aod_lint.py` (`_EXCLUDE_SUFFIXES`).

- **2026-02-21 - GitClient (Phase 1, Task 06/01):** `packages/core/src/git/GitClient.ts` ‚Äî thin wrapper over `simple-git` (v3.x) implementing `initRepository`, `status`, `add`, `commit`. Uses `upath` for path normalization. `GitError` is the typed error class. `commit()` injects `user.name=devs-agent` / `user.email=devs@local` as local git config if not set (no host git config assumed). AOD: `.agent/packages/core/git/GitClient.agent.md` + directory overview `.agent/packages/core/git/.agent.md`. 34 unit tests ‚Äî all pass.

- **2026-02-21 - `simple-git` Named Import Requirement (Phase 1, Task 06/01):** With `moduleResolution: NodeNext`, `simple-git` MUST be imported using named imports: `import { simpleGit, type SimpleGit } from 'simple-git'`. The default import (`import simpleGit from 'simple-git'`) resolves to the module namespace object, which TypeScript does not treat as callable and causes `TS2349` errors. This applies to both production code and test mocks (`vi.mocked(simpleGit)` requires the named import).

- **2026-02-21 - `vitest.config.ts` is NOT included in root `tsconfig.json`:** The root `tsconfig.json` only includes `packages/**/*` and `src/**/*`. The root-level `vitest.config.ts` is outside these paths and NOT type-checked by `tsc --noEmit`. This means typos/wrong field names in `vitest.config.ts` silently pass TypeScript. Always use `reporters: ["verbose"]` (plural, array ‚Äî the correct Vitest v4 API); do NOT use the deprecated `reporter: "verbose"` (singular).

- **2026-02-21 - Database Connection Manager (Phase 2, Task 01):** `packages/core/src/persistence/database.ts` provides `createDatabase(options?)`, `getDatabase(options?)` (singleton), and `closeDatabase()`. Uses `better-sqlite3` with PRAGMA `journal_mode = WAL`, `synchronous = NORMAL`, and `foreign_keys = ON`. The `DatabaseOptions.dbPath` override is used in tests to write to isolated temp dirs without triggering project-root resolution. `fs-extra`'s `ensureDirSync` creates the `.devs/` dir on first use. Both a factory function AND singleton are exported ‚Äî the factory is for tests, the singleton for production use. Vitest v4 with `pool: "forks"` required for native addon compatibility (better-sqlite3).

- **2026-02-21 - Core Tables Schema (Phase 2, Task 02):** `packages/core/src/persistence/schema.ts` exports `initializeSchema(db)` and `CORE_TABLES`. Runs all 7 DDL `CREATE TABLE IF NOT EXISTS` statements inside a single `db.transaction()` (atomic schema migration). Tables: `projects`, `documents`, `requirements`, `epics`, `tasks` (with `git_commit_hash`), `agent_logs` (with `thread_id`), `entropy_events` (with `hash_chain`). All FKs use `ON DELETE CASCADE`. `foreign_keys = ON` is the responsibility of `createDatabase()` ‚Äî schema init is decoupled from connection management. ERD documented at `docs/architecture/database_schema.md`. Audit script at `scripts/db_audit.ts`.

- **2026-02-21 - Vitest Testing Infrastructure (Phase 2, Task 01):** Vitest v4 installed as root AND `packages/core` devDependency. Root `vitest.config.ts` discovers all tests matching `packages/*/test/**/*.test.ts` and `packages/*/src/**/*.test.ts`. Per-package `vitest.config.ts` files exist for running tests from within a package directory. `./do test` now runs `pnpm exec vitest run` as the final step after all bash verification scripts. Root `package.json` test script changed to `vitest run` (enabling `pnpm test <file>` for single-file runs). `esbuild` and `better-sqlite3` added to `pnpm.onlyBuiltDependencies` in root `package.json` to allow native build scripts in pnpm v10.

- **2026-02-21 - Zod v4 API Note (Phase 2, Task 03):** `zod@4.3.6` installed as `@devs/core` production dependency. Breaking change from v3: `z.record()` requires **two** arguments: `z.record(z.string(), valueSchema)`. One-argument form causes a TypeScript error.

- **2026-02-21 - SqliteManager WAL & File Hardening (Phase 3, Task 01):** `packages/core/src/persistence/SqliteManager.ts` implements security-hardened SQLite access required by TAS-070 and 8_RISKS-REQ-093. Key decisions: (1) The database file is **pre-created** via `fs.openSync(path, 'w', 0o600)` before better-sqlite3 opens it ‚Äî this prevents SQLite from creating a 0644 file via the default umask. (2) `_assertPermissions()` reads `statSync` on every `open()` call and throws `"insecure file permissions"` if `(mode & 0o177) !== 0` ‚Äî this rejects any mode with group, other, or owner-execute bits set. A naive numeric `mode > 0o600` comparison is **insufficient** because modes like `0o444` (all-read, 292 decimal < 384 decimal) would silently pass it even though they grant group/other read access. (3) `open()` is idempotent ‚Äî it returns the same `Database` instance on repeat calls. (4) Module-level singleton (`getSqliteManager` / `closeSqliteManager`) ensures better-sqlite3 is initialised once per process. Coexists with `database.ts` (different requirements). Standalone verification at `scripts/verify_db_hardening.ts`.

- **2026-02-21 - StateRepository Pattern (Phase 2, Task 04):** `packages/core/src/persistence/state_repository.ts` is the single entry point for reading/writing all 7 core entity types. Constructor accepts a `Database.Database` instance (injection-friendly, no singleton coupling). ALL prepared statements (14 total: 8 write + 6 query) are compiled once in the constructor and stored as `private readonly` fields. Bulk write methods (`saveRequirements`, `saveEpics`, `saveTasks`) use `db.transaction()` for ACID atomicity ‚Äî a failing row rolls back the entire batch. `upsertProject` uses two prepared statements: (1) `INSERT INTO ... ON CONFLICT(id) DO UPDATE SET` when id is known (safe in-place update, no cascade delete), (2) plain `INSERT INTO` when id is undefined (lets AUTOINCREMENT assign a fresh id). All single-row write methods return `Number(result.lastInsertRowid)` to enable FK chaining without extra queries. `getProjectState` joins tasks and agent_logs through epics to scope them to the project ‚Äî avoids cross-project contamination in multi-project DBs.

- **2026-02-21 - SAOP Interaction Schemas (Phase 2, Task 03):** Defined `TurnEnvelope` (TAS-112) and RTES event schemas (TAS-113) in `packages/core/src/schemas/`. `TurnEnvelope` fields: `turn_index` (int >= 0), `agent_id`/`role` (AgentId enum), `content` (thought/action/observation strings), `metadata` (version literal "1.0.0", task_id, ISO 8601 timestamp, confidence [0,1], estimated_complexity enum). Five event types in discriminated union keyed on `"type"`: `THOUGHT_STREAM`, `TOOL_LIFECYCLE_INVOKED`, `TOOL_LIFECYCLE_COMPLETED`, `TASK_TRANSITION`, `SANDBOX_PULSE`. All schemas re-exported from `packages/core/src/index.ts`. Architecture documented at `docs/architecture/saop_protocol.md`.

- **2026-02-21 - OrchestratorState and LangGraph Annotation (Phase 1, Task 04/01):** `@langchain/langgraph@1.1.5` and `@langchain/core@1.1.27` installed in `@devs/core`. Defined `OrchestratorState` interface and `OrchestratorAnnotation` (LangGraph channel definition) in `packages/core/src/orchestration/types.ts`. Entity record interfaces (`ProjectConfig`, `DocumentRecord`, `RequirementRecord`, `EpicRecord`, `TaskRecord`, `AgentLogRecord`, `EntropyRecord`) map 1:1 to the planned SQLite tables. Status enumerations for all entity types are defined. `createInitialState(config)` factory exported. `GraphState` type alias derived from `OrchestratorAnnotation.State`. All channels use default "replace" (last-write-wins) reducer. `AgentLogRecord` directly embeds `TurnContent` and `TurnMetadata` from SAOP schemas. All symbols re-exported from `packages/core/src/index.ts`. AOD: `.agent/packages/core/orchestration/types.agent.md`. 32 passing tests. All presubmit checks pass (109 tests total).

---

## ‚ö†Ô∏è Brittle Areas (Proceed with Caution)
*Note parts of the codebase that are prone to breaking, have complex undocumented dependencies, or should generally not be refactored without extreme care.*

- **pnpm-workspace.yaml package list:** Adding or renaming packages requires updating both `pnpm-workspace.yaml` AND `tests/infrastructure/verify_monorepo.sh` (the `REQUIRED_PKGS` array) AND creating a `packages/<name>/tsconfig.json` AND a `packages/<name>/src/index.ts` stub. `verify_typescript_strict.sh` uses the same hardcoded `PACKAGES` array and must also be updated.

- **`module: NodeNext` import requirement:** All relative TypeScript imports MUST use `.js` extension (e.g., `import { foo } from './utils.js'`). This is enforced by `moduleResolution: NodeNext`. Omitting the extension causes TS errors at compile time and runtime resolution failures.

- **`.devs/` is gitignored at runtime:** Only `POLICY.md` and `.gitignore` inside `.devs/` are committed. All SQLite/LanceDB/log files are excluded. Do not add `.devs/` to the root `.gitignore` ‚Äî only the runtime subdirs inside it are excluded via `.devs/.gitignore`.

- **Empty scaffold directories need `.gitkeep`:** `mcp-server/` and `src/` are scaffold-only (no source yet). Git does not track empty directories ‚Äî always add a `.gitkeep` file to any new empty directory that must be present on fresh checkout. Forgetting this will cause `verify_folder_structure.sh` to fail in CI on a clean clone.

- **AOD 1:1 ratio is a hard invariant:** Every new `.ts` production module added to `packages/<pkg>/src/` must be accompanied by a `.agent.md` at the same relative path in `.agent/packages/<pkg>/`. Failure to do so will cause `scripts/aod_lint.py` and `verify_aod_ratio.sh` to fail. Package-level overview files (`.agent/packages/<pkg>/.agent.md`) are excluded from this ratio check. Add `.gitkeep` if a new nested AOD directory is empty.

- **Shell scripts in `tests/infrastructure/` must be executable:** All `.sh` scripts in `tests/infrastructure/` must have the executable bit set (`chmod +x`). The `./do` script invokes them via `bash <script>`, which bypasses the permission, but direct invocation (e.g. by a developer or CI tool) requires the bit. Convention: always `chmod +x` new shell scripts.

- **`simple-git` must use named imports with NodeNext:** `import { simpleGit } from 'simple-git'` ‚Äî NOT the default import. Default import produces `TS2349` ("has no call signatures") in strict NodeNext mode. When mocking in Vitest: `vi.mock('simple-git')` + `vi.mocked(simpleGit).mockReturnValue(...)` using the named import.

- **Scaffolded projects: every empty leaf directory needs a `.gitkeep`:** `scripts/scaffold_project.py` creates a tree of directories, several of which are initially empty. Git silently drops empty directories. When adding new directories to the scaffold layout in `scaffold_project.py`, always pair them with a `write("<dir>/.gitkeep", "")` call. Forgetting this means the subdirectory disappears after the user's first `git init && git add . && git commit`, corrupting the standard project structure.

- **Native addon packages require `pnpm.onlyBuiltDependencies`:** In pnpm v10, build scripts (e.g. `node-gyp rebuild`) are blocked by default. Add package names to the `pnpm.onlyBuiltDependencies` array in root `package.json`. Currently: `["better-sqlite3", "esbuild"]`. Without this, `pnpm install` silently skips the native build and the package won't work at runtime.

- **Vitest must use `pool: "forks"` for native addons:** Worker threads (`pool: "threads"`, vitest default) do not work well with native Node.js addons like `better-sqlite3`. Both `packages/core/vitest.config.ts` and root `vitest.config.ts` MUST specify `pool: "forks"`. Removing this causes cryptic worker thread errors.

- **`fs-extra` v11 requires `@types/fs-extra` separately:** Despite what the npm docs suggest, `fs-extra@11.x` does NOT bundle TypeScript types in the package itself. The `@types/fs-extra` devDependency must be added explicitly to any package that imports `fs-extra`. Failure to add it causes `TS7016: Could not find a declaration file` errors during `tsc --noEmit`.

- **`vitest.config.ts` is not type-checked by the TypeScript project:** The file lives at the repo root, which is outside the `include: ["packages/**/*", "src/**/*"]` patterns in root `tsconfig.json`. TypeScript will NOT catch wrong field names (e.g. `reporter` vs `reporters`) in `vitest.config.ts`. Always cross-check against the Vitest documentation when adding or changing config options.

---

## üìù Recent Changelog
*Append brief summaries of recent agent or user tasks here to keep everyone in sync.*

- **[2026-02-20] - Task Name / ID:** Brief description of changes made. (Template)

- **[2026-02-21] - Phase 1 / 01_setup_pnpm_monorepo:** Verified and confirmed complete pnpm monorepo setup. All 30 verification checks pass. Structure: root `package.json` (private, engines node>=22), `.nvmrc` (22), `.npmrc` (shamefully-hoist=false), `pnpm-workspace.yaml` (7 packages), individual `package.json` per package with `@devs/<name>` scoping, `tests/infrastructure/verify_monorepo.sh`, `README.md`, `docs/infrastructure/monorepo_setup.md`, and `./do` task runner. `pnpm install` resolves workspace links correctly.

- **[2026-02-21] - Phase 1 / 03_setup_project_directories:** Established root directory scaffold: `.devs/` (Flight Recorder), `mcp-server/`, `src/`. `.devs/.gitignore` excludes runtime state (SQLite, LanceDB, logs). `.devs/POLICY.md` documents Developer Agent write-access prohibition. `docs/architecture/directory_structure.md` documents all top-level directory roles. `./do test` now runs both `verify_monorepo.sh` (30 checks) and `verify_folder_structure.sh` (11 checks). All 41 checks pass. Reviewer fixed: added `.gitkeep` to `mcp-server/` and `src/` so empty scaffold directories are tracked by git and present on fresh clone. Reviewer fixed: `verify_folder_structure.sh` was missing executable bit (chmod +x) ‚Äî all shell scripts under `tests/infrastructure/` must be executable for direct invocation consistency.

- **[2026-02-21] - Phase 1 / 04_setup_aod_infrastructure:** Established AOD (Agent-Oriented Documentation) infrastructure. Created `.agent/packages/` mirroring `packages/` with 7 subdirs (core, agents, sandbox, memory, mcp, cli, vscode). Each has a package-level `.agent.md` with YAML front-matter + markdown. Implemented `scripts/aod_lint.py` (Python, standalone, executable) enforcing 1:1 ratio between `packages/<pkg>/src/*.ts` modules and `.agent/packages/<pkg>/*.agent.md` files. Created `tests/infrastructure/verify_aod_ratio.sh` (19 checks). Created `docs/infrastructure/aod_policy.md` defining the invariant and file formats. Updated `./do test` to run `verify_aod_ratio.sh`. All 60 presubmit checks pass (30 + 11 + 19). Reviewer fixed: `module_path_for_aod` in `aod_lint.py` was checking only the exact package-root path for overview files; changed to `aod_file.name == ".agent.md"` to correctly skip ALL directory-level overview files at any nesting depth, preventing false ORPHAN DOC errors if nested subdirectory overviews are added later.

- **[2026-02-21] - Phase 1 / 05_define_shared_state_manifest:** Added `devs` metadata field to root `package.json`. Created `packages/core/src/constants.ts` (STATE_FILE_PATH, DEVS_DIR, MANIFEST_SCHEMA_VERSION) and `packages/core/src/persistence.ts` (findProjectRoot, resolveStatePath, resolveDevsDir). Added `tests/infrastructure/verify_shared_state.sh` (18 checks). `./do test` now runs 3 scripts: 59 total checks pass. Created `docs/architecture/state_sharing.md`.

- **[2026-02-21] - Phase 1 / 02_configure_typescript_strict:** Installed TypeScript 5.9.3 as root devDependency. Created root `tsconfig.json` (strict, ES2022, NodeNext), per-package `tsconfig.json` for all 7 packages (extends root, outDir/rootDir), minimal `packages/*/src/index.ts` stubs. `./do build` now runs `pnpm exec tsc --noEmit`. `./do test` now includes `verify_typescript_strict.sh` (27 checks). All 68 total presubmit checks pass. `docs/infrastructure/typescript_standard.md` created. Reviewer fixed: corrected documentation bug in `typescript_standard.md` ‚Äî "Adding a New Package" incorrectly claimed verify script auto-discovers packages from `pnpm-workspace.yaml`; both verification scripts hardcode the package list and must be manually updated.

- **[2026-02-21] - Phase 1 / 06_git_integration/01_git_client_wrapper:** Implemented `GitClient` in `packages/core/src/git/GitClient.ts`: `initRepository` (idempotent, uses `checkIsRepo`), `status` (returns `WorkspaceStatus`), `add` (single/array, upath normalization), `commit` (returns SHA, injects user identity defaults). `GitError` custom error class with `cause` support. Installed `vitest` at root + `simple-git` and `upath` in `@devs/core`. Created `vitest.config.ts` at root. Updated `./do test` to run `pnpm exec vitest run` after infra scripts. 34 unit tests ‚Äî all pass. AOD docs created at `.agent/packages/core/git/`. Fixed: `simple-git` requires named import `{ simpleGit }` (not default import) with `moduleResolution: NodeNext`. All presubmit checks pass.

- **[2026-02-21] - Phase 1 / 06_implement_scaffolding_utility:** Created `scripts/scaffold_project.py` (Python CLI, `init-project <path>` command). Creates full TAS-040/TAS-104 project layout with AOD, Flight Recorder init, and `devs` metadata in `package.json`. Added `tests/infrastructure/verify_scaffold_utility.sh` (26 checks). `./do test` now runs 4 scripts: 85 total checks pass. Created `docs/usage/project_scaffolding.md`. Reviewer fixes: (1) added `.gitkeep` to all empty leaf subdirectories in scaffolded project (`.agent/modules/`, `mcp-server/src/{tools,resources,prompts}/`, `tests/{unit,integration,e2e,agent}/`, `docs/{research,specs}/`, `.github/workflows/`) so they survive a git round-trip; (2) added `is_file()` guard in `_cmd_init_project` for the edge case where the target path is an existing file; (3) removed misleading `.gitkeep` content string for `mcp-server/` (was wrongly claiming entry point is in mcp-server root); (4) made `scripts/scaffold_project.py` executable (has shebang line).

- **[2026-02-21] - Phase 1 / 06_git_integration/01_git_client_wrapper (Reviewer):** Implementation was high quality ‚Äî no logic changes needed. One fix: `vitest.config.ts` used the deprecated `reporter: "verbose"` (singular) field instead of the correct Vitest v4 API `reporters: ["verbose"]` (plural, array). Corrected and confirmed all 34 tests still pass. Added memory entries for the `vitest.config.ts` type-checking blind spot (file is outside `tsconfig.json` include paths).

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 01_initialize_persistence_layer:** Added `better-sqlite3` (SQLite driver), `fs-extra` (dir creation), `@types/better-sqlite3`, `@types/fs-extra`, `vitest` to `packages/core`. Added `vitest` and `tsx` to root devDependencies. Enabled native builds for `better-sqlite3` and `esbuild` via `pnpm.onlyBuiltDependencies` in root `package.json`. Created `packages/core/src/persistence/database.ts` (createDatabase, getDatabase, closeDatabase) with WAL + NORMAL synchronous PRAGMAs. Created `packages/core/vitest.config.ts` (forks pool for native addons) and root `vitest.config.ts`. Created `packages/core/test/persistence/database.test.ts` (9 passing tests). Created `scripts/verify_db_init.ts` (standalone WAL verification). Updated `./do test` to run `pnpm exec vitest run` after all bash checks. Updated root `package.json` test script to `vitest run` to support `pnpm test <file>`. `docs/architecture/state_sharing.md` updated with database connection manager docs. All checks pass.

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 02_implement_core_tables_schema:** Added `foreign_keys = ON` PRAGMA to `createDatabase()` in `database.ts` (updated AOD doc accordingly). Created `packages/core/src/persistence/schema.ts` (initializeSchema, CORE_TABLES, CoreTable type) ‚Äî DDL for all 7 core tables in a single atomic transaction. Created `packages/core/test/persistence/schema.test.ts` (34 passing tests: table existence, column verification, FK constraint enforcement, ACID rollback). Created `scripts/db_audit.ts` (read-only audit of sqlite_master + table_info). Created `docs/architecture/database_schema.md` (full column reference + Mermaid ERD). Created `.agent/packages/core/persistence/schema.agent.md` (AOD). All 43 unit tests and 121 total presubmit checks pass. Reviewer: no fixes required ‚Äî implementation was production-quality.

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 03_define_interaction_schemas:** Installed `zod@4.3.6` as `packages/core` production dependency. Implemented `packages/core/src/schemas/turn_envelope.ts` (TurnEnvelope + TurnContent + TurnMetadata + AgentId Zod schemas, TAS-112) and `packages/core/src/schemas/events.ts` (5 event payload schemas + EventPayloadSchema discriminated union + EventSchema, TAS-113). Created `packages/core/test/schemas/interaction.test.ts` (34 passing tests). Updated `packages/core/src/index.ts` to barrel-export all schema symbols. Created AOD docs at `.agent/packages/core/schemas/turn_envelope.agent.md` and `.agent/packages/core/schemas/events.agent.md`. Created `docs/architecture/saop_protocol.md`. All presubmit checks pass.

- **[2026-02-21] - Phase 3 / 03_acid_transactions_state_integrity / 01_sqlite_wal_hardening:** Created `packages/core/src/persistence/SqliteManager.ts` ‚Äî hardened SQLite manager (TAS-070, 8_RISKS-REQ-093). Pre-creates `.devs/state.sqlite` with `0o600` permissions, throws on loose permissions at startup, applies WAL + NORMAL synchronous PRAGMAs, provides idempotent `open()` and module-level singleton (`getSqliteManager` / `closeSqliteManager`). Created `packages/core/test/persistence/sqlite_hardening.test.ts` (8 passing tests). Created `.agent/packages/core/persistence/SqliteManager.agent.md` (AOD). Created `scripts/verify_db_hardening.ts` (standalone permission + PRAGMA verification). Updated `packages/core/src/index.ts` barrel export. Reviewer fix: replaced `mode > REQUIRED_MODE` numeric comparison in `_assertPermissions()` with `(mode & 0o177) !== 0` bitwise check ‚Äî the numeric form incorrectly allowed modes like `0o444` (all-read, 292 < 384) to pass; the bitwise form correctly rejects any mode with group/other/execute bits set. Added corresponding edge-case test. All 51 unit tests + 131 infra checks pass.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 01_define_orchestration_state:** Installed `@langchain/langgraph@1.1.5` and `@langchain/core@1.1.27` in `@devs/core`. Created `packages/core/src/orchestration/types.ts` with: status type unions (ProjectStatus, DocumentStatus, RequirementStatus, EpicStatus, TaskStatus); entity record interfaces (ProjectConfig, DocumentRecord, RequirementRecord, EpicRecord, TaskRecord, AgentLogRecord, EntropyRecord) aligned with planned SQLite tables; `OrchestratorState` interface (full serializable engine snapshot); `OrchestratorAnnotation` (LangGraph Annotation.Root with replace-semantics channels); `GraphState` type alias; `createInitialState(config)` factory. Updated `packages/core/src/index.ts` barrel export. Created AOD doc at `.agent/packages/core/orchestration/types.agent.md`. 32 new tests in `packages/core/test/orchestration/state.test.ts`. All 109 tests pass.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 01_define_orchestration_state (Reviewer):** Implementation was high quality ‚Äî no code or test changes required. All 109 presubmit checks pass. Verified: (1) `OrchestratorAnnotation.spec` API is LangGraph v1.x specific; if LangGraph is upgraded, the spec property test at `state.test.ts:456` should be re-verified. (2) `GraphState` (derived via `typeof OrchestratorAnnotation.State`) is structurally equivalent to `OrchestratorState` ‚Äî both use `readonly T[]` arrays ensuring immutability. (3) The `orchestration/` AOD subdirectory has no directory-level `.agent.md` overview (unlike `git/`), matching the pattern established by `schemas/`. This is consistent and acceptable.

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 04_implement_state_repository:** Implemented `StateRepository` class in `packages/core/src/persistence/state_repository.ts`. Entity types exported: `Project`, `Document`, `Requirement`, `Epic`, `Task`, `AgentLog`, `EntropyEvent`, `ProjectState`. Write methods: `upsertProject` (returns id), `addDocument` (returns id), `saveRequirements` (bulk tx), `saveEpics` (bulk tx), `saveTasks` (bulk tx), `appendAgentLog` (returns id), `recordEntropyEvent` (returns id). Query methods: `getProjectState(id)` (full snapshot or null), `getTaskLogs(taskId)` (ordered by id). Created 36-test integration test at `packages/core/test/persistence/state_repository.test.ts`. Created AOD at `.agent/packages/core/persistence/state_repository.agent.md`. Created `scripts/db_stress_test.ts` (11 checks: 1000 bulk requirement writes + 1000 individual log appends + data integrity + WAL verification). All 147 unit tests and all presubmit checks pass. Reviewer fix: query statements (`getProjectState`, `getTaskLogs`) were re-compiled on every method call, inconsistent with the class JSDoc claim and the pattern used for write statements. Moved all 6 query statements to the constructor as `private readonly` fields (now 14 total prepared statements, all pre-compiled).

