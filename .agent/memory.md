# Agent Long-Term Memory

This file serves as a shared, long-term memory for all agents working on this project. Agents should append to this document to record important architectural decisions, recurring issues, project-wide conventions, and any other crucial context that future tasks will benefit from.

## üèõÔ∏è Architectural Decisions
*Note overarching design choices, patterns, or project-wide conventions here.*

- **2026-02-20 - Initial Setup:** Started long-term memory to ensure agents pass architectural messages to one another. Agents should actively review and append to this doc when making meaningful structural changes.

- **2026-02-21 - pnpm Monorepo Structure (Phase 1, Task 01):** Established the pnpm v9+ monorepo with 7 packages under `packages/` scoped as `@devs/<name>`. Packages: `core`, `agents`, `sandbox`, `memory`, `mcp`, `cli`, `vscode`. Node.js >= 22 enforced via `.nvmrc` and root `package.json` `engines` field. `shamefully-hoist=false` enforced in `.npmrc` to prevent phantom dependencies.

- **2026-02-21 - TAS-096 Module Separation (Phase 1, Task 01):** `@devs/core` must NEVER depend on `@devs/sandbox`. This is a hard constraint enforced by the verification test (`tests/infrastructure/verify_monorepo.sh`). `@devs/sandbox` is strictly isolated. `@devs/core` has no workspace dependencies (only external libs). Consumers of `@devs/core`: `agents`, `mcp`, `cli`, `vscode`.

- **2026-02-21 - Headless-First Design (Phase 1, Task 01):** `@devs/cli` and `@devs/vscode` are UI shells only ‚Äî all business logic must live in `@devs/core`. This separation is intentional and must be maintained through all future phases.

- **2026-02-21 - `./do` Script Pattern:** The `./do` Python script is the project task runner. `./do build` runs `pnpm exec tsc --noEmit` (type check, no output). `./do test` runs `verify_monorepo.sh`, `verify_folder_structure.sh`, and `verify_typescript_strict.sh`. `fmt`, `lint`, and `coverage` remain stubs until real tools are configured in future phases.

- **2026-02-21 - TypeScript Strict Configuration (Phase 1, Task 02):** TypeScript 5.9.3 installed as root devDependency. Root `tsconfig.json`: `strict: true`, `target: ES2022`, `module: NodeNext`, `moduleResolution: NodeNext`, `esModuleInterop: true`, `forceConsistentCasingInFileNames: true`, `skipLibCheck: true`. Each package has `packages/<name>/tsconfig.json` extending `../../tsconfig.json` with `outDir: ./dist`, `rootDir: ./src`. Minimal `src/index.ts` stubs created per package for `tsc --noEmit` to work without errors. Authoritative documentation at `docs/infrastructure/typescript_standard.md`.

- **2026-02-21 - Root Directory Structure (Phase 1, Task 03):** Eight required top-level directories: `.devs/` (Flight Recorder/observability), `.agent/` (agent docs/memory), `mcp-server/` (MCP server entry), `src/` (root entry points), `tests/` (infra + integration tests), `docs/` (documentation), `scripts/` (admin scripts), `packages/` (monorepo packages). Authoritative description at `docs/architecture/directory_structure.md`.

- **2026-02-21 - Flight Recorder Design (Phase 1, Task 03):** `.devs/` is the Flight Recorder. SQLite (via `better-sqlite3`) and LanceDB (via `vectordb`) runtime state managed exclusively by `@devs/core` and `@devs/memory`. Developer Agents have NO write access to `.devs/` ‚Äî prevents state tampering and loop-counter manipulation. Runtime files are gitignored via `.devs/.gitignore`; only `POLICY.md` and `.gitignore` are tracked in VCS.

- **2026-02-21 - AOD (Agent-Oriented Documentation) Pattern (Phase 1, Task 04):** `.agent/packages/` mirrors `packages/` with one subdirectory per package. Two types of `.agent.md` files: (1) package-level overview at `.agent/packages/<pkg>/.agent.md` (not ratio-checked), (2) module-level docs at `.agent/packages/<pkg>/<path>/<module>.agent.md` (1:1 ratio with source). `scripts/aod_lint.py` enforces the ratio; `tests/infrastructure/verify_aod_ratio.sh` verifies the full infrastructure; `./do test` runs it. All `.agent.md` files must have YAML front-matter (machine-readable). Authoritative policy at `docs/infrastructure/aod_policy.md`.

- **2026-02-21 - Shared State Manifest & STATE_FILE_PATH (Phase 1, Task 05):** `STATE_FILE_PATH = ".devs/state.sqlite"` is the canonical constant defined in `packages/core/src/constants.ts`. All packages MUST import this constant ‚Äî never hardcode the path. `resolveStatePath(fromDir?)` and `findProjectRoot(dir)` in `packages/core/src/persistence.ts` resolve the absolute state path by walking up to the nearest `private: true` `package.json`. Root `package.json` now has a `devs` metadata field: `{ version: "1.0.0", status: "development", architecture: "monorepo" }`. State sharing documented at `docs/architecture/state_sharing.md`.

- **2026-02-21 - Scaffolding Utility (Phase 1, Task 06):** `scripts/scaffold_project.py` implements the `init-project <path>` command. Creates the full TAS-040/TAS-104 directory structure for any new devs project: `.devs/`, `.agent/`, `mcp-server/`, `src/`, `tests/`, `docs/`, `scripts/`, `.github/`. Root files: `.gitignore`, `.env.example`, `README.md`, `package.json` (with `devs.project_id` UUID, `devs.version`, `devs.generated_by`). AOD files: `.agent/index.agent.md`, `.agent/catalog.json`, `.agent/modules/`. Flight Recorder init: `.devs/.gitignore` (excludes `*.sqlite`, LanceDB, logs), `.devs/POLICY.md`. Safety: refuses non-empty target directories. Usage documented at `docs/usage/project_scaffolding.md`.

- **2026-02-21 - Vitest Unit Testing Setup (Phase 1, Task 06/01):** Vitest v4+ installed at root (`-w`) as the project-wide unit test runner. Config at `vitest.config.ts` (root); includes `packages/*/src/**/*.test.ts` and `packages/*/test/**/*.test.ts`. `./do test` now runs `pnpm exec vitest run` as the final step after infrastructure checks. Tests use `vi.mock()` for module mocking (equivalent to `jest.mock`). Test files (`.test.ts`) are excluded from the AOD 1:1 ratio check by `aod_lint.py` (`_EXCLUDE_SUFFIXES`).

- **2026-02-21 - GitClient (Phase 1, Task 06/01):** `packages/core/src/git/GitClient.ts` ‚Äî thin wrapper over `simple-git` (v3.x) implementing `initRepository`, `status`, `add`, `commit`. Uses `upath` for path normalization. `GitError` is the typed error class. `commit()` injects `user.name=devs-agent` / `user.email=devs@local` as local git config if not set (no host git config assumed). AOD: `.agent/packages/core/git/GitClient.agent.md` + directory overview `.agent/packages/core/git/.agent.md`. 34 unit tests ‚Äî all pass.

- **2026-02-21 - `simple-git` Named Import Requirement (Phase 1, Task 06/01):** With `moduleResolution: NodeNext`, `simple-git` MUST be imported using named imports: `import { simpleGit, type SimpleGit } from 'simple-git'`. The default import (`import simpleGit from 'simple-git'`) resolves to the module namespace object, which TypeScript does not treat as callable and causes `TS2349` errors. This applies to both production code and test mocks (`vi.mocked(simpleGit)` requires the named import).

- **2026-02-21 - `vitest.config.ts` is NOT included in root `tsconfig.json`:** The root `tsconfig.json` only includes `packages/**/*` and `src/**/*`. The root-level `vitest.config.ts` is outside these paths and NOT type-checked by `tsc --noEmit`. This means typos/wrong field names in `vitest.config.ts` silently pass TypeScript. Always use `reporters: ["verbose"]` (plural, array ‚Äî the correct Vitest v4 API); do NOT use the deprecated `reporter: "verbose"` (singular).

- **2026-02-21 - Database Connection Manager (Phase 2, Task 01):** `packages/core/src/persistence/database.ts` provides `createDatabase(options?)`, `getDatabase(options?)` (singleton), and `closeDatabase()`. Uses `better-sqlite3` with PRAGMA `journal_mode = WAL`, `synchronous = NORMAL`, and `foreign_keys = ON`. The `DatabaseOptions.dbPath` override is used in tests to write to isolated temp dirs without triggering project-root resolution. `fs-extra`'s `ensureDirSync` creates the `.devs/` dir on first use. Both a factory function AND singleton are exported ‚Äî the factory is for tests, the singleton for production use. Vitest v4 with `pool: "forks"` required for native addon compatibility (better-sqlite3).

- **2026-02-21 - Core Tables Schema (Phase 2, Task 02):** `packages/core/src/persistence/schema.ts` exports `initializeSchema(db)` and `CORE_TABLES`. Runs all 7 DDL `CREATE TABLE IF NOT EXISTS` statements inside a single `db.transaction()` (atomic schema migration). Tables: `projects`, `documents`, `requirements`, `epics`, `tasks` (with `git_commit_hash`), `agent_logs` (with `thread_id`), `entropy_events` (with `hash_chain`). All FKs use `ON DELETE CASCADE`. `foreign_keys = ON` is the responsibility of `createDatabase()` ‚Äî schema init is decoupled from connection management. ERD documented at `docs/architecture/database_schema.md`. Audit script at `scripts/db_audit.ts`.

- **2026-02-21 - Vitest Testing Infrastructure (Phase 2, Task 01):** Vitest v4 installed as root AND `packages/core` devDependency. Root `vitest.config.ts` discovers all tests matching `packages/*/test/**/*.test.ts` and `packages/*/src/**/*.test.ts`. Per-package `vitest.config.ts` files exist for running tests from within a package directory. `./do test` now runs `pnpm exec vitest run` as the final step after all bash verification scripts. Root `package.json` test script changed to `vitest run` (enabling `pnpm test <file>` for single-file runs). `esbuild` and `better-sqlite3` added to `pnpm.onlyBuiltDependencies` in root `package.json` to allow native build scripts in pnpm v10.

- **2026-02-21 - Zod v4 API Note (Phase 2, Task 03):** `zod@4.3.6` installed as `@devs/core` production dependency. Breaking change from v3: `z.record()` requires **two** arguments: `z.record(z.string(), valueSchema)`. One-argument form causes a TypeScript error.

- **2026-02-21 - SqliteManager WAL & File Hardening (Phase 3, Task 01):** `packages/core/src/persistence/SqliteManager.ts` implements security-hardened SQLite access required by TAS-070 and 8_RISKS-REQ-093. Key decisions: (1) The database file is **pre-created** via `fs.openSync(path, 'w', 0o600)` before better-sqlite3 opens it ‚Äî this prevents SQLite from creating a 0644 file via the default umask. (2) `_assertPermissions()` reads `statSync` on every `open()` call and throws `"insecure file permissions"` if `(mode & 0o177) !== 0` ‚Äî this rejects any mode with group, other, or owner-execute bits set. A naive numeric `mode > 0o600` comparison is **insufficient** because modes like `0o444` (all-read, 292 decimal < 384 decimal) would silently pass it even though they grant group/other read access. (3) `open()` is idempotent ‚Äî it returns the same `Database` instance on repeat calls. (4) Module-level singleton (`getSqliteManager` / `closeSqliteManager`) ensures better-sqlite3 is initialised once per process. Coexists with `database.ts` (different requirements). Standalone verification at `scripts/verify_db_hardening.ts`.

- **2026-02-21 - StateRepository Pattern (Phase 2, Task 04):** `packages/core/src/persistence/state_repository.ts` is the single entry point for reading/writing all 7 core entity types. Constructor accepts a `Database.Database` instance (injection-friendly, no singleton coupling). ALL prepared statements (14 total: 8 write + 6 query) are compiled once in the constructor and stored as `private readonly` fields. Bulk write methods (`saveRequirements`, `saveEpics`, `saveTasks`) use `db.transaction()` for ACID atomicity ‚Äî a failing row rolls back the entire batch. `upsertProject` uses two prepared statements: (1) `INSERT INTO ... ON CONFLICT(id) DO UPDATE SET` when id is known (safe in-place update, no cascade delete), (2) plain `INSERT INTO` when id is undefined (lets AUTOINCREMENT assign a fresh id). All single-row write methods return `Number(result.lastInsertRowid)` to enable FK chaining without extra queries. `getProjectState` joins tasks and agent_logs through epics to scope them to the project ‚Äî avoids cross-project contamination in multi-project DBs.

- **2026-02-21 - StateRepository ACID Transaction API (Phase 3, Task 02):** `StateRepository.transaction<T>(cb: () => T): T` is the public transaction primitive. It delegates to `db.transaction(cb)()` from better-sqlite3. Key invariants: (1) **No raw writes** ‚Äî every write method calls `this.transaction()` internally; no `stmt.run()` exists outside a transaction block. (2) **Savepoint nesting** ‚Äî calling `transaction()` inside another active `transaction()` on the same connection automatically uses a SQLite SAVEPOINT; the inner savepoint can fail independently without rolling back the outer transaction. (3) **Rollback on throw** ‚Äî any exception from `cb` triggers automatic ROLLBACK before the exception is re-thrown. (4) **`updateTaskStatus(taskId, status)`** added for task lifecycle transitions (pending ‚Üí in_progress ‚Üí completed/failed); participates in outer transactions. (5) **16 prepared statements** total in constructor (10 write + 6 query) ‚Äî updated to include `_stmtUpdateTaskGitHash`. WAL crash recovery verified empirically by `scripts/simulate_crash_during_write.ts`. Architecture documented at `docs/architecture/acid_transactions.md`.

- **2026-02-21 - Git-Atomic Manager & transactionAsync Pattern (Phase 3, Task 04):** `packages/core/src/orchestration/GitAtomicManager.ts` implements the `commitTaskChange(taskId, commitMessage)` method that atomically binds a SQLite status update to a git commit. Key design: (1) **`StateRepository.transactionAsync<T>(cb: () => Promise<T>)`** ‚Äî new async transaction primitive using explicit SAVEPOINT commands (`SAVEPOINT name` ‚Üí `await cb()` ‚Üí `RELEASE` or `ROLLBACK TO + RELEASE`). Bridges the sync-SQLite / async-git gap. (2) **SAVEPOINT semantics guarantee rollback** ‚Äî rolling back the outer SAVEPOINT also undoes any inner changes from nested `db.transaction()` SAVEPOINTs that have already been RELEASEd, providing true cross-operation atomicity. (3) **`StateRepository.updateTaskGitCommitHash(taskId, hash)`** ‚Äî new write method (16th prepared statement). (4) **`scripts/simulate_git_failure.ts`** ‚Äî 13-check simulation verifying rollback on git failure, success path consistency, and no-git-on-DB-failure invariant. AOD at `.agent/packages/core/orchestration/GitAtomicManager.agent.md`. All 328 unit tests + all infra checks pass.

- **2026-02-21 - SAOP Interaction Schemas (Phase 2, Task 03):** Defined `TurnEnvelope` (TAS-112) and RTES event schemas (TAS-113) in `packages/core/src/schemas/`. `TurnEnvelope` fields: `turn_index` (int >= 0), `agent_id`/`role` (AgentId enum), `content` (thought/action/observation strings), `metadata` (version literal "1.0.0", task_id, ISO 8601 timestamp, confidence [0,1], estimated_complexity enum). Five event types in discriminated union keyed on `"type"`: `THOUGHT_STREAM`, `TOOL_LIFECYCLE_INVOKED`, `TOOL_LIFECYCLE_COMPLETED`, `TASK_TRANSITION`, `SANDBOX_PULSE`. All schemas re-exported from `packages/core/src/index.ts`. Architecture documented at `docs/architecture/saop_protocol.md`.

- **2026-02-21 - OrchestratorState and LangGraph Annotation (Phase 1, Task 04/01):** `@langchain/langgraph@1.1.5` and `@langchain/core@1.1.27` installed in `@devs/core`. Defined `OrchestratorState` interface and `OrchestratorAnnotation` (LangGraph channel definition) in `packages/core/src/orchestration/types.ts`. Entity record interfaces (`ProjectConfig`, `DocumentRecord`, `RequirementRecord`, `EpicRecord`, `TaskRecord`, `AgentLogRecord`, `EntropyRecord`) map 1:1 to the planned SQLite tables. Status enumerations for all entity types are defined. `createInitialState(config)` factory exported. `GraphState` type alias derived from `OrchestratorAnnotation.State`. All channels use default "replace" (last-write-wins) reducer. `AgentLogRecord` directly embeds `TurnContent` and `TurnMetadata` from SAOP schemas. All symbols re-exported from `packages/core/src/index.ts`. AOD: `.agent/packages/core/orchestration/types.agent.md`. 32 passing tests. All presubmit checks pass (109 tests total).

- **2026-02-21 - HITL Approval Gates Pattern (Phase 1, Task 04/04):** `packages/core/src/orchestration/hitl.ts` implements two mandatory HITL gates (`approveDesignNode`, `approveTaskDagNode`) using LangGraph `interrupt()`. Key invariants: (1) `interrupt()` unconditionally pauses ‚Äî no state update is applied until `Command({ resume: signal })` is provided; (2) `OrchestrationGraph` now compiles with `MemorySaver` by default; callers must supply `thread_id` in config for resume to work; (3) `isInterrupted(result)` detects suspended state; `result[INTERRUPT][0].value.gate` identifies the gate; (4) rejection routes back to preceding node (design or distill) for revision cycles; (5) `HitlDecisionRecord` entries in `state.hitlDecisions` provide the audit trail and routing signal; (6) type assertion `as unknown as Record<typeof INTERRUPT, ...>` is required to access `[INTERRUPT]` on the invoke return type ‚Äî TypeScript cannot narrow symbol keys without the double-cast; (7) `"paused_for_approval"` added to `ProjectStatus`; `hitlDecisions` and `pendingApprovalGate` fields added to `OrchestratorState` + `OrchestratorAnnotation`. AOD 1:1 ratio maintained: `hitl.ts` ‚Üí `hitl.agent.md`.

- **2026-02-21 - Git Exclusion & Hidden Files Policy (Phase 1, Task 06/05):** `packages/core/src/git/GitIgnoreManager.ts` manages the `.gitignore` of *generated projects* (not the devs repo). `STANDARD_IGNORES = [".devs/", "node_modules/", "dist/", ".env", ".env.local"]` ‚Äî all appended if missing, idempotent. `TRACKED_DEVS_ARTIFACTS = [".agent/"]` ‚Äî never ignored (AOD density requirement). `SnapshotManager.initialize()` enforces the ordering guarantee: `initRepository ‚Üí ensureStandardIgnores ‚Üí then git add .` is safe. State-file git strategy (UNKNOWN-601): `.devs/state.sqlite` is excluded via `.gitignore` on generated projects ‚Äî no Shadow Git at this stage. AOD docs must always be tracked; they must never appear in `STANDARD_IGNORES`. Integration tests use real `simple-git` + a temp dir git repo to verify actual staging behavior.

- **2026-02-21 - Commit Footer Metadata Pattern (Phase 1, Task 06/04, 8_RISKS-REQ-085):** `CommitMessageGenerator.generate(taskId, metadata)` produces a fixed format: `task: complete {taskId}\n\nTASK-ID: {taskId}\ndevs-state-snapshot: {value}`. The `TASK-ID:` trailer enables `git log --grep="TASK-ID: task-007"` for machine-readable history. `devs-state-snapshot:` embeds either a pre-computed hash (`metadata.hash`) or compact JSON of all remaining fields. Snapshot value capped at `MAX_SNAPSHOT_CHARS = 900` chars ‚Äî total message stays under 1KB. `SnapshotContext.stateSnapshot?: StateSnapshotData` added to pass state info into `createTaskSnapshot`. When `stateSnapshot` is omitted, defaults to `{}` (produces `devs-state-snapshot: {}`). `CommitMessageGenerator` is stateless (static methods only) ‚Äî no instantiation needed. `StateSnapshotData` is exported from both `CommitMessageGenerator.ts` and the barrel `index.ts`.

- **2026-02-21 - Task Snapshot-at-Commit Pattern (Phase 1, Task 06/02):** `SnapshotManager.createTaskSnapshot(taskId, context)` implements TAS-054. Returns `string` (commit SHA) if dirty, `null` if clean (skip). The standard commit message is `task: complete task {taskId}`. `SnapshotContext` is an interface with optional `taskName?: string` ‚Äî reserved for future enrichment (commit trailers, etc.) but currently unused. `ImplementationNode` (`packages/core/src/orchestration/ImplementationNode.ts`) is the LangGraph node factory that: (1) calls `initialize()` (idempotent), (2) calls `createTaskSnapshot()`, (3) optionally calls `TaskRepository.updateGitHash(dbTaskId, hash)` when `taskRepository` and `dbTaskId` are both configured, (4) maps `string | null` return to state updates. The factory pattern (`createImplementationNode(config)`) is used instead of a class to enable dependency injection of `snapshotManager` for tests. Node returns `Partial<GraphState>` ‚Äî `{}` on no-op, `{ tasks: updatedTasks }` on success.

- **2026-02-21 - Glass-Box Audit Log Schema (Phase 7, Task 01):** `agent_logs` table updated to the full Glass-Box schema: `role` (agent persona), `content_type` ('THOUGHT'|'ACTION'|'OBSERVATION'), `content` (NOT NULL JSON blob), `epic_id` (optional FK ‚Üí epics for epic-scoped queries), `commit_hash` (optional, links to git state). Old columns (agent_role, thread_id, thought, action, observation) removed. New `decision_logs` table: `id`, `task_id` (NOT NULL FK ‚Üí tasks), `timestamp`, `alternative_considered`, `reasoning_for_rejection`, `selected_option`. Five performance indices created by `audit_schema.ts` via `initializeAuditSchema(db)`. `StateRepository.appendAgentLog()` updated to use new `AgentLog` interface. All audit schema content should be stored as `content: JSON.stringify({...})` blobs.

- **2026-02-21 - DecisionLogger Service (Phase 7, Task 04, TAS-059):** `packages/core/src/audit/DecisionLogger.ts` provides the structured agent API for decision capture. Pattern: orchestrator binds `task_id` at construction time, eliminating per-call ID passing. Three public write methods: `recordDecision(record)` (atomic primitive, any subset of fields), `logAlternative(alt, reason)` (convenience wrapper), `confirmSelection(selection)` (convenience wrapper). Each call inserts one independent `decision_logs` row (no update-existing-row pattern). `searchDecisions(query)` uses `LIKE ? COLLATE NOCASE` scoped to `task_id`. The module lives in `packages/core/src/audit/` (new subdirectory distinct from `persistence/`) ‚Äî this is intentional: `audit/` will house higher-level audit services; `persistence/` holds raw DB schema and repository patterns.

- **2026-02-21 - TaskRepository & Git Hash Persistence (Phase 1, Task 06/03):** `packages/core/src/persistence/TaskRepository.ts` implements focused task-scoped persistence for the Git Integration strategy. Key design: (1) `updateGitHash(taskId, hash)` uses `changes === 0` detection (from better-sqlite3 `RunResult`) to throw `TaskNotFoundError` on missing tasks ‚Äî avoids a SELECT-then-UPDATE pattern and prevents silent no-ops; (2) `getTaskByGitHash(hash)` enables `devs rewind <sha>` time-travel command to locate the task implemented by a given commit; (3) `getTask(taskId)` retrieves a single task row by numeric PK; (4) All write methods wrapped in `this.transaction()` ‚Äî participates in outer transactions via SQLite SAVEPOINT nesting. `ImplementationNode` updated to accept optional `taskRepository?: TaskRepository` and `dbTaskId?: number` ‚Äî when both present AND a commit hash is produced, calls `taskRepository.updateGitHash(dbTaskId, hash)` before updating LangGraph state. `TaskNotFoundError` is a typed custom error class with a `taskId: number` property for programmatic handling. All 426 unit tests + all infra checks pass.

- **2026-02-21 - Git Integrity Check Pattern (Phase 1, Task 06/06, 8_RISKS-REQ-127):** `GitIntegrityChecker` provides two separate checks that are run BEFORE every snapshot: (1) `verifyWorkspace()` checks for dirty state (uncommitted changes) + HEAD reachability (missing/detached HEAD). Uses `git.status()` (not porcelain string) which naturally excludes gitignored files. (2) `checkObjectStoreIntegrity()` runs lightweight `git fsck --connectivity-only --no-dangling --quiet` ‚Äî fast enough to run before every commit but still catches object graph disconnections. Key design: both methods return structured result objects (never throw) ‚Äî the CALLER decides whether to throw (`GitIntegrityViolationError`) or handle gracefully. `ImplementationNode` receives optional `integrityChecker` and, when violations are found, returns `{ status: "security_pause", projectConfig: { ...projectConfig, status: "security_pause" } }` (updates BOTH the top-level `status` field AND the embedded `projectConfig.status`). `withRetry<T>()` is a static utility for transient lock errors ‚Äî NOT called automatically within `GitIntegrityChecker` itself; callers opt in by wrapping operations. `"security_pause"` added to `ProjectStatus` union in `types.ts`.

- **2026-02-21 - State Machine Robustness and Error Recovery (Phase 1, Task 04/05):** `packages/core/src/orchestration/robustness.ts` implements error recovery, turn-budget enforcement, entropy detection, chaos recovery, and a PivotAgent stub. Key decisions: (1) `ErrorRecord` stores masked messages and stack traces ‚Äî `maskSensitiveData()` redacts Bearer tokens, API keys, AWS IDs, passwords, and basic-auth URLs before any error is persisted. (2) `errorNode` synthesizes errors from `state.pendingRecoveryNode` (the source node name) ‚Äî actual pipeline nodes must catch exceptions, set `pendingRecoveryNode` to their name, and route to `"error"` rather than propagating exceptions through LangGraph. (3) `MAX_IMPLEMENTATION_TURNS = 10` enforced by `implementNode` via `checkTurnBudget()`. (4) `ENTROPY_LOOP_THRESHOLD = 3` enforced by `implementNode` via `detectEntropy()`. (5) `CONSECUTIVE_ERROR_PIVOT_THRESHOLD = 3` enforced by `routeAfterError()`. (6) `pivotAgentNode` is a stub ‚Äî routes to `END` in the current graph; full AI-agent strategy pivot is deferred to a later phase. (7) `findStaleOrDirtyStates` returns `StaleTaskInfo[]` for tasks with `"in_progress"` status on startup; the rewind/resume UX is deferred. Three new `OrchestratorState` fields: `errorHistory`, `implementationTurns`, `pendingRecoveryNode`. Two new `ProjectStatus` values: `"error"`, `"strategy_pivot"`. AOD at `.agent/packages/core/orchestration/robustness.agent.md`. 75 new unit tests. Total: 450 tests pass.

- **2026-02-21 - SQLite Persistence Integration (Phase 1, Task 04/03):** Added two static helpers to `OrchestrationGraph`: (1) `OrchestrationGraph.withSqlitePersistence(db: Database.Database)` ‚Äî production factory that creates an `OrchestrationGraph` with `SqliteSaver` as the checkpointer; (2) `OrchestrationGraph.configForProject(projectId: string)` ‚Äî returns `{ configurable: { thread_id: projectId } }`, mapping the `projectId` to LangGraph's `thread_id` for per-project checkpoint isolation. The `checkpoint_id` is auto-assigned by LangGraph per checkpoint; `activeTaskId` is embedded in the serialized state blob. Crash recovery pattern: run graph ‚Üí close DB ‚Üí reopen same file ‚Üí `new OrchestrationGraph(saverRecovered)` ‚Üí `invoke(new Command({ resume }), config)`. Created `packages/core/src/orchestration/__tests__/persistence.test.ts` (16 tests: WAL mode, node transition checkpointing, thread_id isolation, requirement DAG serialization, crash recovery + zero data loss, ACID guarantees). Updated AOD at `.agent/packages/core/orchestration/graph.agent.md`. Total: 502 tests pass.

---

## ‚ö†Ô∏è Brittle Areas (Proceed with Caution)
*Note parts of the codebase that are prone to breaking, have complex undocumented dependencies, or should generally not be refactored without extreme care.*

- **pnpm-workspace.yaml package list:** Adding or renaming packages requires updating both `pnpm-workspace.yaml` AND `tests/infrastructure/verify_monorepo.sh` (the `REQUIRED_PKGS` array) AND creating a `packages/<name>/tsconfig.json` AND a `packages/<name>/src/index.ts` stub. `verify_typescript_strict.sh` uses the same hardcoded `PACKAGES` array and must also be updated.

- **`module: NodeNext` import requirement:** All relative TypeScript imports MUST use `.js` extension (e.g., `import { foo } from './utils.js'`). This is enforced by `moduleResolution: NodeNext`. Omitting the extension causes TS errors at compile time and runtime resolution failures.

- **`.devs/` is gitignored at runtime:** Only `POLICY.md` and `.gitignore` inside `.devs/` are committed. All SQLite/LanceDB/log files are excluded. Do not add `.devs/` to the root `.gitignore` ‚Äî only the runtime subdirs inside it are excluded via `.devs/.gitignore`.

- **Empty scaffold directories need `.gitkeep`:** `mcp-server/` and `src/` are scaffold-only (no source yet). Git does not track empty directories ‚Äî always add a `.gitkeep` file to any new empty directory that must be present on fresh checkout. Forgetting this will cause `verify_folder_structure.sh` to fail in CI on a clean clone.

- **AOD 1:1 ratio is a hard invariant:** Every new `.ts` production module added to `packages/<pkg>/src/` must be accompanied by a `.agent.md` at the same relative path in `.agent/packages/<pkg>/`. Failure to do so will cause `scripts/aod_lint.py` and `verify_aod_ratio.sh` to fail. Package-level overview files (`.agent/packages/<pkg>/.agent.md`) are excluded from this ratio check. Add `.gitkeep` if a new nested AOD directory is empty.

- **Shell scripts in `tests/infrastructure/` must be executable:** All `.sh` scripts in `tests/infrastructure/` must have the executable bit set (`chmod +x`). The `./do` script invokes them via `bash <script>`, which bypasses the permission, but direct invocation (e.g. by a developer or CI tool) requires the bit. Convention: always `chmod +x` new shell scripts.

- **`@devs/core` barrel export must be kept in sync with new persistence modules:** `packages/core/src/index.ts` is the single barrel export for the package. When new modules are added to `packages/core/src/persistence/` or `packages/core/src/orchestration/`, they must be explicitly added to `index.ts`. TypeScript does not warn when a module is usable via its file path but missing from the barrel ‚Äî the only symptom is that `import { X } from "@devs/core"` silently fails at runtime (module not found or symbol undefined). README examples that reference package-level imports (`@devs/core`) must be verified against `index.ts`. Currently exported persistence modules: `database.ts`, `SqliteManager.ts`. `schema.ts` and `state_repository.ts` are NOT yet in the barrel.

- **`checkpoint_writes` has no FK constraint to `checkpoints`:** The `checkpoint_writes` DDL does not define a `FOREIGN KEY (thread_id, checkpoint_ns, checkpoint_id) REFERENCES checkpoints(...)`. Referential integrity is enforced by application logic only (`deleteThread` explicitly deletes writes before checkpoints). If a FK constraint is added later, `deleteThread` must still delete `checkpoint_writes` before `checkpoints` to avoid FK violations.

- **`SqliteSaver.list()` does not implement `options.before`:** `CheckpointListOptions.before` (a `RunnableConfig` for filtering checkpoints older than a specific checkpoint) is part of the interface contract but ignored. This is safe for the current linear DAG orchestration graph. If branching / parallel runs are introduced in later phases, resumption semantics may silently return too many checkpoints.

- **`og.graph.nodes` accesses an internal LangGraph API:** The topology tests in `packages/core/test/orchestration/graph.test.ts` use `Object.keys(og.graph.nodes)` to assert that all 5 nodes are registered. The `.nodes` property is an internal LangGraph field, not part of the public API contract. If LangGraph renames or restructures this field in a future version, these tests will break silently (the `Object.keys()` call would return `[]` instead of throwing). Monitor on LangGraph upgrades.

- **`simple-git` must use named imports with NodeNext:** `import { simpleGit } from 'simple-git'` ‚Äî NOT the default import. Default import produces `TS2349` ("has no call signatures") in strict NodeNext mode. When mocking in Vitest: `vi.mock('simple-git')` + `vi.mocked(simpleGit).mockReturnValue(...)` using the named import.

- **Scaffolded projects: every empty leaf directory needs a `.gitkeep`:** `scripts/scaffold_project.py` creates a tree of directories, several of which are initially empty. Git silently drops empty directories. When adding new directories to the scaffold layout in `scaffold_project.py`, always pair them with a `write("<dir>/.gitkeep", "")` call. Forgetting this means the subdirectory disappears after the user's first `git init && git add . && git commit`, corrupting the standard project structure.

- **Native addon packages require `pnpm.onlyBuiltDependencies`:** In pnpm v10, build scripts (e.g. `node-gyp rebuild`) are blocked by default. Add package names to the `pnpm.onlyBuiltDependencies` array in root `package.json`. Currently: `["better-sqlite3", "esbuild"]`. Without this, `pnpm install` silently skips the native build and the package won't work at runtime.

- **Vitest must use `pool: "forks"` for native addons:** Worker threads (`pool: "threads"`, vitest default) do not work well with native Node.js addons like `better-sqlite3`. Both `packages/core/vitest.config.ts` and root `vitest.config.ts` MUST specify `pool: "forks"`. Removing this causes cryptic worker thread errors.

- **`fs-extra` v11 requires `@types/fs-extra` separately:** Despite what the npm docs suggest, `fs-extra@11.x` does NOT bundle TypeScript types in the package itself. The `@types/fs-extra` devDependency must be added explicitly to any package that imports `fs-extra`. Failure to add it causes `TS7016: Could not find a declaration file` errors during `tsc --noEmit`.

- **`vitest.config.ts` is not type-checked by the TypeScript project:** The file lives at the repo root, which is outside the `include: ["packages/**/*", "src/**/*"]` patterns in root `tsconfig.json`. TypeScript will NOT catch wrong field names (e.g. `reporter` vs `reporters`) in `vitest.config.ts`. Always cross-check against the Vitest documentation when adding or changing config options.

- **`noUnusedLocals` / `noUnusedParameters` are NOT enabled:** Root `tsconfig.json` sets `strict: true` but does not enable `noUnusedLocals` or `noUnusedParameters`. Dead imports and unused parameters pass `tsc --noEmit` silently. Always manually audit imports when writing scripts that evolved from earlier prototypes.

- **`errorNode` requires explicit routing from caller nodes:** LangGraph cannot pass `Error` objects between nodes via state. Pipeline nodes that want error recovery must: (1) catch the exception, (2) set `state.pendingRecoveryNode` to their own node name, and (3) return that partial state before routing to `"error"` via a conditional edge. The `errorNode` then synthesizes an `ErrorRecord` from `pendingRecoveryNode`. Without this contract, exceptions will propagate out of LangGraph and crash the process. Real agent nodes (to be implemented in later phases) must follow this error-routing pattern.

- **`@langchain/langgraph` does NOT re-export all checkpoint types:** `CheckpointListOptions`, `ChannelVersions`, and `PendingWrite` are defined in the transitive dependency `@langchain/langgraph-checkpoint` but are NOT re-exported from `@langchain/langgraph`. Importing them from `@langchain/langgraph` causes `TS2305` errors at build time. Solution: define structurally-equivalent local type aliases in the implementation file (`ChannelVersions = Record<string, number | string>`, `PendingWrite = [string, unknown]`, `CheckpointListOptions = { limit?, before?, filter? }`). These are checked by TypeScript against the abstract method signatures of `BaseCheckpointSaver` at compile time.

- **`SchemaReconciler.revert()` table recreation drops ALL indexes:** When `_revertTableColumns` recreates a table (rename‚Üícreate‚Üícopy‚Üídrop), ALL indexes on that table are dropped ‚Äî including pre-existing baseline indexes that are NOT embedded in the `CREATE TABLE` DDL. `revert()` must explicitly restore ALL baseline explicit indexes for any table that was recreated. Failing to do so leaves the table without those indexes even though `diff()` may not detect it (since the pre-existing baseline index was not in `addedIndexes` or `removedIndexes` of the diff). This is the most subtle invariant in SchemaReconciler ‚Äî always restore baseline indexes after table recreation.

- **`initializeAuditSchema(db)` must be called AFTER `initializeSchema(db)`:** `audit_schema.ts` adds performance indices to `agent_logs` (created by `schema.ts`) and creates `decision_logs` which has an FK to `tasks` (also created by `schema.ts`). Calling `initializeAuditSchema` on a fresh DB without calling `initializeSchema` first will throw a "no such table" error. The call order is: `createDatabase()` ‚Üí `initializeSchema()` ‚Üí `initializeAuditSchema()`.

- **`agent_logs` schema is Glass-Box (Phase 7 onwards):** The old `agent_logs` schema (`agent_role`, `thread_id`, `thought`, `action`, `observation`) was completely replaced in Phase 7. The new schema uses a JSON blob pattern: `role` (agent persona), `content_type` (THOUGHT/ACTION/OBSERVATION discriminator), `content` (JSON blob). Any code or test written before Phase 7 that uses the old column names WILL BREAK and must be updated. The new schema also adds `epic_id` (optional FK for epic-scoped queries) and `commit_hash` (links log to git state).

- **`DecisionLogger` constructor validates task existence:** `new DecisionLogger(db, taskId)` runs a SELECT to verify the task exists before accepting the binding. If the task id is wrong (e.g. stale from a previous run), construction fails immediately with a descriptive error. This is intentional ‚Äî do NOT remove the validation check to "make tests easier"; seed the task in the test fixture instead.

---

## üìù Recent Changelog
*Append brief summaries of recent agent or user tasks here to keep everyone in sync.*

- **[2026-02-20] - Task Name / ID:** Brief description of changes made. (Template)

- **[2026-02-21] - Phase 1 / 01_setup_pnpm_monorepo:** Verified and confirmed complete pnpm monorepo setup. All 30 verification checks pass. Structure: root `package.json` (private, engines node>=22), `.nvmrc` (22), `.npmrc` (shamefully-hoist=false), `pnpm-workspace.yaml` (7 packages), individual `package.json` per package with `@devs/<name>` scoping, `tests/infrastructure/verify_monorepo.sh`, `README.md`, `docs/infrastructure/monorepo_setup.md`, and `./do` task runner. `pnpm install` resolves workspace links correctly.

- **[2026-02-21] - Phase 1 / 03_setup_project_directories:** Established root directory scaffold: `.devs/` (Flight Recorder), `mcp-server/`, `src/`. `.devs/.gitignore` excludes runtime state (SQLite, LanceDB, logs). `.devs/POLICY.md` documents Developer Agent write-access prohibition. `docs/architecture/directory_structure.md` documents all top-level directory roles. `./do test` now runs both `verify_monorepo.sh` (30 checks) and `verify_folder_structure.sh` (11 checks). All 41 checks pass. Reviewer fixed: added `.gitkeep` to `mcp-server/` and `src/` so empty scaffold directories are tracked by git and present on fresh clone. Reviewer fixed: `verify_folder_structure.sh` was missing executable bit (chmod +x) ‚Äî all shell scripts under `tests/infrastructure/` must be executable for direct invocation consistency.

- **[2026-02-21] - Phase 1 / 04_setup_aod_infrastructure:** Established AOD (Agent-Oriented Documentation) infrastructure. Created `.agent/packages/` mirroring `packages/` with 7 subdirs (core, agents, sandbox, memory, mcp, cli, vscode). Each has a package-level `.agent.md` with YAML front-matter + markdown. Implemented `scripts/aod_lint.py` (Python, standalone, executable) enforcing 1:1 ratio between `packages/<pkg>/src/*.ts` modules and `.agent/packages/<pkg>/*.agent.md` files. Created `tests/infrastructure/verify_aod_ratio.sh` (19 checks). Created `docs/infrastructure/aod_policy.md` defining the invariant and file formats. Updated `./do test` to run `verify_aod_ratio.sh`. All 60 presubmit checks pass (30 + 11 + 19). Reviewer fixed: `module_path_for_aod` in `aod_lint.py` was checking only the exact package-root path for overview files; changed to `aod_file.name == ".agent.md"` to correctly skip ALL directory-level overview files at any nesting depth, preventing false ORPHAN DOC errors if nested subdirectory overviews are added later.

- **[2026-02-21] - Phase 1 / 05_define_shared_state_manifest:** Added `devs` metadata field to root `package.json`. Created `packages/core/src/constants.ts` (STATE_FILE_PATH, DEVS_DIR, MANIFEST_SCHEMA_VERSION) and `packages/core/src/persistence.ts` (findProjectRoot, resolveStatePath, resolveDevsDir). Added `tests/infrastructure/verify_shared_state.sh` (18 checks). `./do test` now runs 3 scripts: 59 total checks pass. Created `docs/architecture/state_sharing.md`.

- **[2026-02-21] - Phase 1 / 02_configure_typescript_strict:** Installed TypeScript 5.9.3 as root devDependency. Created root `tsconfig.json` (strict, ES2022, NodeNext), per-package `tsconfig.json` for all 7 packages (extends root, outDir/rootDir), minimal `packages/*/src/index.ts` stubs. `./do build` now runs `pnpm exec tsc --noEmit`. `./do test` now includes `verify_typescript_strict.sh` (27 checks). All 68 total presubmit checks pass. `docs/infrastructure/typescript_standard.md` created. Reviewer fixed: corrected documentation bug in `typescript_standard.md` ‚Äî "Adding a New Package" incorrectly claimed verify script auto-discovers packages from `pnpm-workspace.yaml`; both verification scripts hardcode the package list and must be manually updated.

- **[2026-02-21] - Phase 1 / 06_git_integration/01_git_client_wrapper:** Implemented `GitClient` in `packages/core/src/git/GitClient.ts`: `initRepository` (idempotent, uses `checkIsRepo`), `status` (returns `WorkspaceStatus`), `add` (single/array, upath normalization), `commit` (returns SHA, injects user identity defaults). `GitError` custom error class with `cause` support. Installed `vitest` at root + `simple-git` and `upath` in `@devs/core`. Created `vitest.config.ts` at root. Updated `./do test` to run `pnpm exec vitest run` after infra scripts. 34 unit tests ‚Äî all pass. AOD docs created at `.agent/packages/core/git/`. Fixed: `simple-git` requires named import `{ simpleGit }` (not default import) with `moduleResolution: NodeNext`. All presubmit checks pass.

- **[2026-02-21] - Phase 1 / 06_implement_scaffolding_utility:** Created `scripts/scaffold_project.py` (Python CLI, `init-project <path>` command). Creates full TAS-040/TAS-104 project layout with AOD, Flight Recorder init, and `devs` metadata in `package.json`. Added `tests/infrastructure/verify_scaffold_utility.sh` (26 checks). `./do test` now runs 4 scripts: 85 total checks pass. Created `docs/usage/project_scaffolding.md`. Reviewer fixes: (1) added `.gitkeep` to all empty leaf subdirectories in scaffolded project (`.agent/modules/`, `mcp-server/src/{tools,resources,prompts}/`, `tests/{unit,integration,e2e,agent}/`, `docs/{research,specs}/`, `.github/workflows/`) so they survive a git round-trip; (2) added `is_file()` guard in `_cmd_init_project` for the edge case where the target path is an existing file; (3) removed misleading `.gitkeep` content string for `mcp-server/` (was wrongly claiming entry point is in mcp-server root); (4) made `scripts/scaffold_project.py` executable (has shebang line).

- **[2026-02-21] - Phase 1 / 06_git_integration/01_git_client_wrapper (Reviewer):** Implementation was high quality ‚Äî no logic changes needed. One fix: `vitest.config.ts` used the deprecated `reporter: "verbose"` (singular) field instead of the correct Vitest v4 API `reporters: ["verbose"]` (plural, array). Corrected and confirmed all 34 tests still pass. Added memory entries for the `vitest.config.ts` type-checking blind spot (file is outside `tsconfig.json` include paths).

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 01_initialize_persistence_layer:** Added `better-sqlite3` (SQLite driver), `fs-extra` (dir creation), `@types/better-sqlite3`, `@types/fs-extra`, `vitest` to `packages/core`. Added `vitest` and `tsx` to root devDependencies. Enabled native builds for `better-sqlite3` and `esbuild` via `pnpm.onlyBuiltDependencies` in root `package.json`. Created `packages/core/src/persistence/database.ts` (createDatabase, getDatabase, closeDatabase) with WAL + NORMAL synchronous PRAGMAs. Created `packages/core/vitest.config.ts` (forks pool for native addons) and root `vitest.config.ts`. Created `packages/core/test/persistence/database.test.ts` (9 passing tests). Created `scripts/verify_db_init.ts` (standalone WAL verification). Updated `./do test` to run `pnpm exec vitest run` after all bash checks. Updated root `package.json` test script to `vitest run` to support `pnpm test <file>`. `docs/architecture/state_sharing.md` updated with database connection manager docs. All checks pass.

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 02_implement_core_tables_schema:** Added `foreign_keys = ON` PRAGMA to `createDatabase()` in `database.ts` (updated AOD doc accordingly). Created `packages/core/src/persistence/schema.ts` (initializeSchema, CORE_TABLES, CoreTable type) ‚Äî DDL for all 7 core tables in a single atomic transaction. Created `packages/core/test/persistence/schema.test.ts` (34 passing tests: table existence, column verification, FK constraint enforcement, ACID rollback). Created `scripts/db_audit.ts` (read-only audit of sqlite_master + table_info). Created `docs/architecture/database_schema.md` (full column reference + Mermaid ERD). Created `.agent/packages/core/persistence/schema.agent.md` (AOD). All 43 unit tests and 121 total presubmit checks pass. Reviewer: no fixes required ‚Äî implementation was production-quality.

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 03_define_interaction_schemas:** Installed `zod@4.3.6` as `packages/core` production dependency. Implemented `packages/core/src/schemas/turn_envelope.ts` (TurnEnvelope + TurnContent + TurnMetadata + AgentId Zod schemas, TAS-112) and `packages/core/src/schemas/events.ts` (5 event payload schemas + EventPayloadSchema discriminated union + EventSchema, TAS-113). Created `packages/core/test/schemas/interaction.test.ts` (34 passing tests). Updated `packages/core/src/index.ts` to barrel-export all schema symbols. Created AOD docs at `.agent/packages/core/schemas/turn_envelope.agent.md` and `.agent/packages/core/schemas/events.agent.md`. Created `docs/architecture/saop_protocol.md`. All presubmit checks pass.

- **[2026-02-21] - Phase 3 / 03_acid_transactions_state_integrity / 01_sqlite_wal_hardening:** Created `packages/core/src/persistence/SqliteManager.ts` ‚Äî hardened SQLite manager (TAS-070, 8_RISKS-REQ-093). Pre-creates `.devs/state.sqlite` with `0o600` permissions, throws on loose permissions at startup, applies WAL + NORMAL synchronous PRAGMAs, provides idempotent `open()` and module-level singleton (`getSqliteManager` / `closeSqliteManager`). Created `packages/core/test/persistence/sqlite_hardening.test.ts` (8 passing tests). Created `.agent/packages/core/persistence/SqliteManager.agent.md` (AOD). Created `scripts/verify_db_hardening.ts` (standalone permission + PRAGMA verification). Updated `packages/core/src/index.ts` barrel export. Reviewer fix: replaced `mode > REQUIRED_MODE` numeric comparison in `_assertPermissions()` with `(mode & 0o177) !== 0` bitwise check ‚Äî the numeric form incorrectly allowed modes like `0o444` (all-read, 292 < 384) to pass; the bitwise form correctly rejects any mode with group/other/execute bits set. Added corresponding edge-case test. All 51 unit tests + 131 infra checks pass.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 01_define_orchestration_state:** Installed `@langchain/langgraph@1.1.5` and `@langchain/core@1.1.27` in `@devs/core`. Created `packages/core/src/orchestration/types.ts` with: status type unions (ProjectStatus, DocumentStatus, RequirementStatus, EpicStatus, TaskStatus); entity record interfaces (ProjectConfig, DocumentRecord, RequirementRecord, EpicRecord, TaskRecord, AgentLogRecord, EntropyRecord) aligned with planned SQLite tables; `OrchestratorState` interface (full serializable engine snapshot); `OrchestratorAnnotation` (LangGraph Annotation.Root with replace-semantics channels); `GraphState` type alias; `createInitialState(config)` factory. Updated `packages/core/src/index.ts` barrel export. Created AOD doc at `.agent/packages/core/orchestration/types.agent.md`. 32 new tests in `packages/core/test/orchestration/state.test.ts`. All 109 tests pass.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 01_define_orchestration_state (Reviewer):** Implementation was high quality ‚Äî no code or test changes required. All 109 presubmit checks pass. Verified: (1) `OrchestratorAnnotation.spec` API is LangGraph v1.x specific; if LangGraph is upgraded, the spec property test at `state.test.ts:456` should be re-verified. (2) `GraphState` (derived via `typeof OrchestratorAnnotation.State`) is structurally equivalent to `OrchestratorState` ‚Äî both use `readonly T[]` arrays ensuring immutability. (3) The `orchestration/` AOD subdirectory has no directory-level `.agent.md` overview (unlike `git/`), matching the pattern established by `schemas/`. This is consistent and acceptable.

- **[2026-02-21] - Phase 2 / 02_sqlite_schema_persistence_layer / 04_implement_state_repository:** Implemented `StateRepository` class in `packages/core/src/persistence/state_repository.ts`. Entity types exported: `Project`, `Document`, `Requirement`, `Epic`, `Task`, `AgentLog`, `EntropyEvent`, `ProjectState`. Write methods: `upsertProject` (returns id), `addDocument` (returns id), `saveRequirements` (bulk tx), `saveEpics` (bulk tx), `saveTasks` (bulk tx), `appendAgentLog` (returns id), `recordEntropyEvent` (returns id). Query methods: `getProjectState(id)` (full snapshot or null), `getTaskLogs(taskId)` (ordered by id). Created 36-test integration test at `packages/core/test/persistence/state_repository.test.ts`. Created AOD at `.agent/packages/core/persistence/state_repository.agent.md`. Created `scripts/db_stress_test.ts` (11 checks: 1000 bulk requirement writes + 1000 individual log appends + data integrity + WAL verification). All 147 unit tests and all presubmit checks pass. Reviewer fix: query statements (`getProjectState`, `getTaskLogs`) were re-compiled on every method call, inconsistent with the class JSDoc claim and the pattern used for write statements. Moved all 6 query statements to the constructor as `private readonly` fields (now 14 total prepared statements, all pre-compiled).

- **[2026-02-21] - Phase 1 / 06_git_integration_snapshot_strategy / 05_git_exclusion_strategy:** Created `packages/core/src/git/GitIgnoreManager.ts` (UNKNOWN-601, UNKNOWN-602) ‚Äî static class that manages `.gitignore` for generated projects. `ensureStandardIgnores(projectPath)` appends `STANDARD_IGNORES` (`.devs/`, `node_modules/`, `dist/`, `.env`, `.env.local`) to the project's `.gitignore` if missing; idempotent. `TRACKED_DEVS_ARTIFACTS` (`.agent/`) is never added to `.gitignore` (AOD density requirement). `isDevsIgnored()` / `isTrackedDevsArtifact()` helpers for path classification. Created `packages/core/src/git/SnapshotManager.ts` ‚Äî wraps `GitClient` with the exclusion strategy: `initialize()` calls `initRepository` + `ensureStandardIgnores`; `takeSnapshot(message)` calls `git add . && git commit`; `.devs/` excluded automatically via `.gitignore`. Updated `packages/core/src/index.ts` to export new symbols. Added AOD docs: `GitIgnoreManager.agent.md`, `SnapshotManager.agent.md`, updated `git/.agent.md`. Unit tests: 32 (`GitIgnoreManager`) + 13 (`SnapshotManager`). Integration tests (real git): 6 in `packages/core/test/git/exclusion_integration.test.ts` ‚Äî verify `.devs/state.sqlite` not staged, `.agent/` tracked, `.env` ignored, `.env.example` tracked. All 170 unit tests + all infra checks pass. Reviewer fix: corrected `SnapshotManager.agent.md` test count from 14 to 13 (matched actual test file).

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 02_implement_cyclical_graph:** `packages/core/src/orchestration/graph.ts` implements the `OrchestrationGraph` class wrapping a compiled LangGraph `StateGraph`. Five stub nodes: `researchNode` ("researching"), `designNode` ("specifying"), `distillNode` ("planning"), `implementNode` ("implementing"), `verifyNode` (updates task status). Two feedback loops: (1) `verify ‚Üí implement` retry loop when `activeTask.status === "failed"`; (2) `verify ‚Üí distill` advancement loop when epics remain. `routeAfterVerify` priority: failed-task check first ‚Üí active-epics check ‚Üí terminate (return `END`). The `addConditionalEdges("verify", routeAfterVerify)` call without a pathMap uses return strings directly as node names. `VerifyRoute` type exported for downstream tooling. All 33 new tests pass. `docs/architecture/orchestration_graph.md` contains Mermaid topology diagram. Reviewer: implementation was production-quality ‚Äî no code or test changes required. `addConditionalEdges` without a pathMap is the correct LangGraph v1.x pattern; node functions are individually exported for unit testability; `readonly graph` inferred type gives callers full LangGraph inference. AOD 1:1 ratio maintained: `graph.ts` ‚Üí `graph.agent.md`.

- **[2026-02-21] - Phase 3 / 03_acid_transactions_state_integrity / 02_acid_state_repository:** Extended `StateRepository` with full ACID transaction management. Added `transaction<T>(cb: () => T): T` public method ‚Äî delegates to `db.transaction(cb)()` from better-sqlite3; automatically uses SQLite SAVEPOINTs when nested. Added `updateTaskStatus(taskId, status)` method for orchestrator task lifecycle transitions. Refactored ALL write methods (`upsertProject`, `addDocument`, `saveRequirements`, `saveEpics`, `saveTasks`, `appendAgentLog`, `recordEntropyEvent`) to call `this.transaction()` internally ‚Äî enforcing the "no raw non-transactional writes" invariant. Created 26-test ACID test file at `packages/core/test/persistence/StateRepository.test.ts` (multi-step commit, rollback, nested savepoints, updateTaskStatus, all-methods rollback, isolation). Created `scripts/simulate_crash_during_write.ts` (10-check crash simulation: child process dies mid-transaction, WAL recovery verified). Updated `.agent/packages/core/persistence/state_repository.agent.md` with transaction API docs. Created `docs/architecture/acid_transactions.md` (ACID design guide). All 213 unit tests and all presubmit checks pass. Reviewer fix: removed unused `execFileSync` import from `scripts/simulate_crash_during_write.ts` (dead import, slips past `tsc --noEmit` because `noUnusedLocals` is not enabled).

- **[2026-02-21] - Phase 1 / 06_git_integration_snapshot_strategy / 02_task_commit_logic:** Extended `packages/core/src/git/SnapshotManager.ts` with `SnapshotContext` interface and `createTaskSnapshot(taskId, context): Promise<string | null>`. Implements the "Snapshot-at-Commit" strategy (TAS-054): checks `status()` first ‚Äî returns `null` (skip) if workspace is clean; otherwise calls `add('.') + commit('task: complete task {taskId}')` and returns the commit SHA. Created `packages/core/src/orchestration/ImplementationNode.ts` ‚Äî factory `createImplementationNode(config)` returns a LangGraph node function that calls `initialize()` + `createTaskSnapshot()` and updates `TaskRecord.gitHash` in `OrchestratorState`. Added 10 new tests to `SnapshotManager.test.ts` (23 total) + 11 tests in `ImplementationNode.test.ts`. Created AOD at `.agent/packages/core/orchestration/ImplementationNode.agent.md`. Updated `packages/core/src/index.ts` to export new symbols. All 259 unit tests + all infra checks pass.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 04_implement_hitl_gates:** Created `packages/core/src/orchestration/hitl.ts` implementing two mandatory HITL approval gates using LangGraph's `interrupt()` mechanism. Gates: `approveDesignNode` (after design, before distill) and `approveTaskDagNode` (after distill, before implement). Both call `interrupt()` to unconditionally pause the graph ‚Äî no autonomous bypass is possible. Routing: `routeAfterApproveDesign` ‚Üí "distill" (approved) | "design" (rejected); `routeAfterApproveTaskDag` ‚Üí "implement" (approved) | "distill" (rejected). Updated `types.ts` with `HitlGate`, `HitlApprovalSignal`, `HitlDecisionRecord`, `"paused_for_approval"` status, plus `hitlDecisions: readonly HitlDecisionRecord[]` and `pendingApprovalGate: HitlGate | null` fields in `OrchestratorState` and `OrchestratorAnnotation`. Updated `graph.ts`: added 2 HITL nodes, updated edges, `OrchestrationGraph` constructor now accepts optional `BaseCheckpointSaver` (defaults to `new MemorySaver()`). Updated `graph.test.ts` full pipeline tests to use 3-step HITL flow (invoke ‚Üí approve design ‚Üí approve DAG). Added 31 new HITL tests in `packages/core/test/orchestration/hitl.test.ts`. AOD docs: `hitl.agent.md` (new) + `graph.agent.md` (updated). All 302 tests pass. Presubmit fully green. Reviewer fix: `state.test.ts` spec test was missing `hitlDecisions` and `pendingApprovalGate` assertions ‚Äî the two new HITL channels were added to `OrchestratorAnnotation` but the "all required state keys" test was not updated. Added both assertions.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 05_robustness_and_error_handling:** Created `packages/core/src/orchestration/robustness.ts` ‚Äî global `errorNode`, `pivotAgentNode` (stub), `checkTurnBudget` / `incrementTurnBudget` / `resetTurnBudget`, `detectEntropy`, `findStaleOrDirtyStates`, `maskSensitiveData`, `classifyError`, `buildErrorRecord`, `countConsecutiveErrors`. Updated `types.ts`: added `ErrorRecord` type, `ErrorKind` type, `"error"` / `"strategy_pivot"` to `ProjectStatus`, `errorHistory` / `implementationTurns` / `pendingRecoveryNode` fields to `OrchestratorState` + `OrchestratorAnnotation` + `createInitialState`. Updated `graph.ts`: added `error` and `pivot_agent` nodes to topology; `implementNode` now checks turn budget + entropy before executing; `routeAfterVerify` routes to `"pivot_agent"` when `pendingRecoveryNode` signals it. Created 75-test suite at `packages/core/test/orchestration/robustness.test.ts`. Created AOD at `.agent/packages/core/orchestration/robustness.agent.md`. Updated `packages/core/src/index.ts` barrel export. Updated `state.test.ts` to cover new status values and channels. All 450 tests pass. All presubmit checks pass. Reviewer fixes: (1) Removed dead `ERROR_SENTINEL` constant from `robustness.ts` ‚Äî it was exported but never used and its JSDoc was inconsistent with the actual implementation (the code stores a node name in `pendingRecoveryNode`, not a sentinel value); (2) Removed redundant re-exports `export { errorNode, pivotAgentNode, routeAfterError }` and `export type { ErrorRoute }` from `graph.ts` ‚Äî these created barrel ambiguity since `index.ts` already exports `* from robustness.js` and no test consumed them from `graph.ts`; (3) Updated `robustness.agent.md` to document the `ErrorRoute` and `StaleTaskInfo` exported types that were missing from the AOD exports table.

- **[2026-02-21] - Phase 1 / 04_langgraph_core_orchestration_engine / 03_integrate_sqlite_persistence:** Added `OrchestrationGraph.withSqlitePersistence(db)` and `OrchestrationGraph.configForProject(projectId)` static methods to `packages/core/src/orchestration/graph.ts`. Updated imports in `graph.ts` to include `better-sqlite3` type, `@langchain/core/runnables` `RunnableConfig`, and `SqliteSaver`. Created 16-test suite at `packages/core/src/orchestration/__tests__/persistence.test.ts` covering: WAL mode, per-node checkpoint rows, thread_id/projectId correlation, project isolation, `withSqlitePersistence` factory, `configForProject` helper, requirement DAG serialization, crash recovery (reconnect + resume), zero data loss (BLOB byte comparison), ACID table existence, `deleteThread` cleanup. Updated AOD at `.agent/packages/core/orchestration/graph.agent.md` with new static methods, crash recovery pattern, and test count. All 502 tests pass. All presubmit checks pass. Reviewer fixes: (1) Removed dead `type ErrorRoute` import from `graph.ts` ‚Äî it was left over from the prior phase's re-export removal and is unused in graph.ts (TypeScript infers the type from `routeAfterError` directly); (2) Fixed `packages/core/vitest.config.ts` ‚Äî per-package config only included `test/**/*.test.ts`, causing `src/orchestration/__tests__/persistence.test.ts` to be excluded when running `pnpm test packages/core`; added `src/**/*.test.ts` to the include list so the per-package runner discovers all co-located tests alongside the root runner.

- **[2026-02-21] - Phase 1 / 03_acid_transactions_state_integrity / 03_langgraph_sqlite_saver:** Implemented `SqliteSaver` class in `packages/core/src/orchestration/SqliteSaver.ts` ‚Äî a `BaseCheckpointSaver` subclass backed by `better-sqlite3`. Creates two tables idempotently (`checkpoints`, `checkpoint_writes`). Schema: `checkpoints` has `(thread_id, checkpoint_ns, checkpoint_id)` composite PK + `parent_checkpoint_id`, `type`, `checkpoint` BLOB, `metadata` BLOB, `created_at`; `checkpoint_writes` has `(thread_id, checkpoint_ns, checkpoint_id, task_id, idx)` composite PK + `channel`, `type`, `value` BLOB. All 8 prepared statements compiled once in the constructor. Key ACID decisions: (1) `put()` wraps its `INSERT OR REPLACE` in `db.transaction(fn)()` ‚Äî crash mid-write leaves the previous checkpoint intact; (2) `putWrites()` wraps all write rows in a single transaction; (3) `deleteThread()` deletes from both tables in a single transaction. Serialization: `checkpoint` and `metadata` go through the inherited `serde.dumpsTyped()`/`loadsTyped()` protocol; `putWrites` channel values are stored as `JSON.stringify()` strings. `_stmtPutCheckpoint` exposed as non-private for spy-based transaction tests. `close()` swallows already-closed errors for safe `afterEach` use. Key discovery: `CheckpointListOptions`, `ChannelVersions`, `PendingWrite` are NOT exported from `@langchain/langgraph` ‚Äî they live in `@langchain/langgraph-checkpoint` (transitive). Defined structurally-equivalent local type aliases in the implementation file to avoid the implicit transitive dependency. Added to `packages/core/src/index.ts` barrel. Created AOD at `.agent/packages/core/orchestration/SqliteSaver.agent.md`. 23 unit tests ‚Äî all pass. All 320 total presubmit tests pass. Reviewer fixes: (1) Removed dead `config` variable in the node-transition test (declared but never passed to `invoke`); (2) Corrected AOD doc ‚Äî `checkpoint_writes` reference columns are *not* FK-constrained at DB level (no `FOREIGN KEY` clause in DDL), updated notation from "FK to" to "Logical ref to (no FK constraint)"; (3) Added Phase 1 limitation note in `list()` JSDoc and AOD about `options.before` not being implemented (sufficient for the current linear DAG; Phase 13 will add it).

- **[2026-02-21] - Phase 3 / 03_acid_transactions_state_integrity / 04_git_atomic_manager:** Implemented `GitAtomicManager` in `packages/core/src/orchestration/GitAtomicManager.ts` (requirements: 8_RISKS-REQ-041, 8_RISKS-REQ-094). Coordinates a git commit with a SQLite status update in one atomic unit using `StateRepository.transactionAsync()`. Extended `StateRepository` with: (1) `transactionAsync<T>(cb: () => Promise<T>)` ‚Äî async SAVEPOINT-based primitive that remains open while awaiting async ops; (2) `updateTaskGitCommitHash(taskId, hash)` ‚Äî 16th prepared statement. `commitTaskChange(taskId, commitMessage)` execution: updateTaskStatus('completed') ‚Üí await gitClient.commit() ‚Üí updateTaskGitCommitHash(hash) ‚Äî all inside one SAVEPOINT. Git failure ‚Üí SAVEPOINT rolled back, DB reverts to 'pending'. DB failure ‚Üí git never invoked. Created `packages/core/test/orchestration/GitAtomicManager.test.ts` (10 tests: 6 unit/mock + 4 integration/real-SQLite). Created `scripts/simulate_git_failure.ts` (13 checks: 3 scenarios). Created AOD at `.agent/packages/core/orchestration/GitAtomicManager.agent.md`. Updated `packages/core/src/index.ts` barrel export. All 328 unit tests + all infra checks pass.

- **[2026-02-21] - Phase 3 / 03_acid_transactions_state_integrity / 05_schema_drift_reconciliation:** Created `packages/core/src/persistence/SchemaReconciler.ts` ‚Äî schema drift detection and reconciliation (8_RISKS-REQ-073). Core API: `snapshot()` captures schema-only state from `sqlite_master` + PRAGMA table_info + PRAGMA index_list; `diff(baseline)` compares current schema to a snapshot returning `SchemaDiff` (addedTables, removedTables, modifiedTables, hasChanges); `revert(baseline)` restores pre-task schema in a single transaction. Key design: (1) Only explicit CREATE INDEX entries (`origin = 'c'`) are captured ‚Äî implicit UNIQUE/PK indexes are part of the CREATE TABLE DDL; (2) Table recreation strategy for column changes (rename ‚Üí DDL recreate ‚Üí copy common cols ‚Üí drop tmp) handles all SQLite versions without `DROP COLUMN`; (3) After table recreation in `revert()`, ALL baseline explicit indexes for that table are restored ‚Äî critical because table recreation drops ALL associated indexes, even pre-existing ones not part of the DDL; (4) FK enforcement suspended (`PRAGMA foreign_keys = OFF`) during revert with `try/finally` restoration; (5) Multi-pass table drop loop handles FK dependencies among task-created tables. Created 26-test suite at `packages/core/test/persistence/SchemaReconciler.test.ts`. Created `scripts/simulate_failed_migration.ts` (25 checks, all passing). Created AOD at `.agent/packages/core/persistence/SchemaReconciler.agent.md`. All 375 unit tests + all infra checks pass. Reviewer fix: AOD file claimed "32 unit tests" but actual count is 26 (9 snapshot + 6 diff + 7 revert + 4 integration) ‚Äî corrected to 26.

- **[2026-02-21] - Phase 5 / 05_state_checkpointing_recovery / 01_sqlite_saver_implementation:** `SqliteSaver` was already fully implemented in Phase 1 / 03_acid_transactions_state_integrity / 03_langgraph_sqlite_saver. This task added the remaining artifacts: (1) `scripts/verify_checkpoints.ts` (16 checks across 4 scenarios: full graph run, node crash recovery, ACID atomicity mid-transaction, disk visibility via raw SQL); (2) `packages/core/README.md` with comprehensive `SqliteSaver` documentation covering schema, ACID guarantees, WAL mode, usage examples, and the full persistence layer overview. All 382 unit tests + all infra checks pass. Key finding: the `verify_checkpoints.ts` script must use `async function main() {}` + `main().catch()` pattern ‚Äî tsx uses CJS output format and does NOT support top-level await. Reviewer fix: `packages/core/src/index.ts` was missing the barrel export for `database.ts` (`createDatabase`, `getDatabase`, `closeDatabase`) ‚Äî the README usage example imported `createDatabase` from `@devs/core` but the export wasn't present. Added `export * from "./persistence/database.js"` to index.ts. All 382 tests still pass.

- **[2026-02-21] - Phase 1 / 06_git_integration_snapshot_strategy / 04_commit_footer_metadata:** Created `packages/core/src/git/CommitMessageGenerator.ts` (8_RISKS-REQ-085). Stateless class with a single static method `CommitMessageGenerator.generate(taskId, metadata)` that produces a conventional commit message with a structured state-snapshot footer. Format: `task: complete {taskId}\n\nTASK-ID: {taskId}\ndevs-state-snapshot: {value}`. Snapshot value: `metadata.hash` used verbatim if present; otherwise compact JSON of all non-`hash` fields. Snapshot capped at 900 chars (with `...` suffix) to keep total message under 1KB. Integrated into `SnapshotManager.createTaskSnapshot()`: `SnapshotContext` extended with `stateSnapshot?: StateSnapshotData`; `createTaskSnapshot` calls `CommitMessageGenerator.generate(taskId, context.stateSnapshot ?? {})` to build the commit message (replacing the old hardcoded `task: complete task ${taskId}` string). Added `export * from "./git/CommitMessageGenerator.js"` to barrel. Created AOD at `.agent/packages/core/git/CommitMessageGenerator.agent.md`. 26 unit tests in `CommitMessageGenerator.test.ts` + 3 new integration tests added to `SnapshotManager.test.ts` (26 total, up from 23). Old `SnapshotManager` tests checking the legacy commit message format updated. All 515 unit tests + all infra checks pass.

- **[2026-02-21] - Phase 1 / 06_git_integration_snapshot_strategy / 03_git_hash_persistence:** Created `packages/core/src/persistence/TaskRepository.ts` (TAS-095, TAS-114, 9_ROADMAP-REQ-015) ‚Äî focused repository for task-scoped git hash operations. Key: `TaskNotFoundError` typed error class; `updateGitHash(taskId, hash)` uses `changes === 0` detection to throw on non-existent tasks; `getTask(taskId)` retrieves by PK; `getTaskByGitHash(hash)` enables `devs rewind <sha>` time-travel lookup. Created 14-test integration suite at `packages/core/test/persistence/TaskRepository.test.ts`. Updated `ImplementationNode.ts` to accept optional `taskRepository` + `dbTaskId` ‚Äî when both present and a commit hash is produced, calls `updateGitHash` to persist the hash to SQLite before updating LangGraph state. Added 4 new tests to `ImplementationNode.test.ts` (15 total). Created AOD at `.agent/packages/core/persistence/TaskRepository.agent.md`. Updated `packages/core/src/index.ts` barrel export. All 426 unit tests + all infra checks pass.

- **[2026-02-21] - Phase 1 / 06_git_integration_snapshot_strategy / 03_git_hash_persistence (Reviewer):** Implementation was production-quality ‚Äî no logic changes required. One fix: `TaskRepository.test.ts` `seedTask` helper had a dead variable (`const epicId = stateRepo.saveEpics(...)  as unknown as number`) followed by `void epicId;` ‚Äî `saveEpics` returns `void`, making the assignment a lie. Removed the assignment and the `void` suppressor; helper now calls `stateRepo.saveEpics(...)` as a statement. All 426 tests still pass.

- **[2026-02-21] - Phase 1 / 06_git_integration_snapshot_strategy / 06_git_integrity_and_recovery:** Created `packages/core/src/git/GitIntegrityChecker.ts` (8_RISKS-REQ-127). Two-method stateless class: (1) `verifyWorkspace(path)` ‚Äî three-check pass: dirty detection via `git.status()` (ignores gitignored files), HEAD reachability via `git.raw(['rev-parse', '--verify', 'HEAD'])`, branch check via `git.raw(['symbolic-ref', '--quiet', 'HEAD'])`; returns structured `IntegrityCheckResult` (never throws). (2) `checkObjectStoreIntegrity(path)` ‚Äî lightweight git object-store check via `git.raw(['fsck', '--connectivity-only', '--no-dangling', '--quiet'])`; exit-0 = healthy, non-zero = corruption; returns `ObjectStoreCheckResult` (never throws). (3) `withRetry<T>(operation, options?)` ‚Äî static helper that retries transient lock-file errors (`.git/index.lock`, `.git/COMMIT_EDITMSG.lock`) up to `maxAttempts` times with exponential backoff; non-transient errors rethrown immediately. `GitIntegrityViolationError` error class lets callers convert results to exceptions. Integrated into `ImplementationNode`: optional `integrityChecker?: GitIntegrityChecker` in `ImplementationNodeConfig`; when provided, `verifyWorkspace` + `checkObjectStoreIntegrity` run pre-snapshot; failure returns `{ status: "security_pause", projectConfig: { ...projectConfig, status: "security_pause" } }` and NO snapshot is created. Added `"security_pause"` to `ProjectStatus` union in `types.ts`. 40 unit tests in `GitIntegrityChecker.test.ts` + 11 new tests in `ImplementationNode.test.ts` (22 total). AOD at `.agent/packages/core/git/GitIntegrityChecker.agent.md`. All 566 unit tests + all infra checks pass. Reviewer fix: renamed `_err` to `err` in the detached-HEAD `catch` block ‚Äî the variable IS used in the violation `details` field regardless of the `headReachable` guard, making the underscore prefix misleading and inconsistent with the rest of the file.

- **[2026-02-21] - Phase 7 / 07_audit_trails_glass-box_observability / 01_define_agent_log_schemas:** Updated `agent_logs` DDL in `schema.ts` to the Glass-Box schema: `role`, `content_type`, `content` (JSON blob), `epic_id` (optional FK), `commit_hash` (optional). Removed old columns: `agent_role`, `thread_id`, `thought`, `action`, `observation`. Created `packages/core/src/persistence/audit_schema.ts` which adds `decision_logs` table and 5 performance indices (`idx_agent_logs_task_id`, `idx_agent_logs_epic_id`, `idx_agent_logs_timestamp`, `idx_decision_logs_task_id`, `idx_decision_logs_timestamp`). Updated `StateRepository.AgentLog` interface + `appendAgentLog()` prepared statement. Updated all 5 test files that used old `AgentLog` interface. Created `audit_schemas.test.ts` (48 tests). Created AOD at `.agent/packages/core/persistence/audit_schema.agent.md`. Added barrel export to `index.ts`. All 582 tests pass. Reviewer fix: changed `db.exec()` to `db.prepare().run()` for index DDL in `audit_schema.ts` for consistency with `schema.ts`; corrected test count from 51 to 48 in memory.

- **[2026-02-21] - Phase 7 / 07_audit_trails_glass-box_observability / 04_decision_logs_capture_system:** Implemented `DecisionLogger` service in `packages/core/src/audit/DecisionLogger.ts` (TAS-059). Key design: (1) `task_id` is bound at **constructor time** ‚Äî agents never pass it per-call; the orchestrator injects one `DecisionLogger` instance per executing task; (2) constructor validates the task exists via a SELECT before accepting the binding (early explicit error, not a silent FK violation on first write); (3) `logAlternative(alternative, reasonForRejection)` and `confirmSelection(selection)` are convenience wrappers around the atomic primitive `recordDecision(record)`; each call inserts one independent row (rather than a two-phase insert+update pattern); (4) `searchDecisions(query)` uses `LIKE ? COLLATE NOCASE` with `WHERE task_id = ?` scoping ‚Äî case-insensitive substring match across `alternative_considered`, `reasoning_for_rejection`, and `selected_option`; (5) all writes use `db.transaction(fn)()` with SAVEPOINT nesting support; (6) `DecisionLog` and `DecisionRecord` interfaces exported for callers. Created 28-test integration suite at `packages/core/test/audit/decision_logger.test.ts`. Created AOD at `.agent/packages/core/audit/DecisionLogger.agent.md`. Added barrel export to `index.ts`. All 677 unit tests + all infra checks pass. Reviewer fix: the "returns multiple matches" test used the query `"cache"` with a wrong comment claiming it matches 2 rows (it matches only 1: "Memcached", not "caching" ‚Äî the substring "caching" ‚â† "cache"). Fixed by switching to query `"use"` which correctly matches 2 rows (both "Use Redis for caching" and "Use Memcached"). Assertion strengthened from vague `toBeGreaterThanOrEqual(1)` to precise `toHaveLength(2)`.

