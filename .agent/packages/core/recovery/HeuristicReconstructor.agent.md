---
module: packages/core/src/recovery/HeuristicReconstructor.ts
phase: 5
task: "05_state_checkpointing_recovery/05_heuristic_state_reconstruction"
requirements: ["1_PRD-REQ-MET-014", "1_PRD-REQ-CON-002"]
exports:
  functions:
    - reconstructStateFromProject
dependencies:
  internal:
    - packages/core/src/persistence/state_repository.ts
    - packages/core/src/persistence/schema.ts
  external:
    - "better-sqlite3"
    - "fs-extra"
tests: 4
---

# `packages/core/src/recovery/HeuristicReconstructor.ts`

Best-effort heuristic state reconstruction that scans `.agent/` documentation and
source code comments to extract requirement identifiers and rebuild a minimal
`.devs/state.sqlite` when the DB is missing. Reconstructed state is marked via
project metadata `{ reconstructed: true, method: "HEURISTICALLY_RECONSTRUCTED" }`.

## Key Design Points

- Operates in a best-effort mode: may not recover full runtime state but provides
  a minimal set of requirements, epics, and tasks to allow the orchestration
  engine to resume in a documented, auditable way.
- Uses a conservative ID regex (`/[A-Z]{2,}[-_]\d{2,}/g`) to locate requirement
  identifiers in both `.agent/` docs and `src/` files.
- Pre-creates the `.devs/state.sqlite` file with `0o600` permissions before
  opening it with `better-sqlite3` to ensure file hardening.
- Delegates persistence operations to `StateRepository` and `initializeSchema` to
  avoid duplicating DDL or business-logic rules.

## API

### `reconstructStateFromProject(projectDir?: string): void`

Scans the project for heuristic identifiers and persists minimal requirements,
an epic named "Heuristic Reconstruction", and autogenerated tasks mapping to
those requirements. Safe to call during DB initialization; idempotent for
already-existing entries.

## Tests

Unit and integration tests live in `packages/core/test/recovery/HeuristicRecovery.test.ts`.
