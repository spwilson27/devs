# Task: Implement MCP-Native Integration and AOD Manifest for the ProjectServer Template (Sub-Epic: 08_ProjectServer Template)

## Covered Requirements
- [3_MCP-TAS-003], [3_MCP-TAS-081], [4_USER_FEATURES-REQ-012], [TAS-043]

## 1. Initial Test Written
- [ ] In `packages/devs-core/src/templates/__tests__/aodManifest.test.ts`, write unit tests for the AOD manifest completeness validation:
  - Load the `.agent/index.agent.md` template string from `ProjectServerTemplateScaffolder`.
  - Assert it contains a `## Tools` section with a Markdown table whose header row includes the columns `Tool`, `Parameters`, `Return Type`, and `Description`.
  - Assert the table contains one row for each of the five introspection tools: `inspect_state`, `run_test_task`, `db_bridge`, `capture_trace`, `get_logs`.
  - Assert it contains an `## Introspection Points` section with at least one bullet point per tool describing what runtime state it surfaces.
  - Assert it contains a `## Lifecycle` section describing when the server starts and stops.

- [ ] In `packages/devs-core/src/templates/__tests__/mcpCapabilities.test.ts`, write an integration test verifying the full MCP capabilities of the generated server satisfy [3_MCP-TAS-003]:
  - Scaffold, build, and start the template server in a temp directory.
  - Send `initialize` and `tools/list` via STDIO.
  - Assert `initialize` result contains:
    - `serverInfo.name === "project-mcp-server"` and `serverInfo.version` matching semver pattern.
    - `capabilities.tools` is defined (not null/undefined).
  - Assert `tools/list` result contains all five tools with their correct JSON Schema input schemas:
    - `inspect_state`: schema has `path` (string, required) and `depth` (integer, optional, default 3).
    - `run_test_task`: schema has `test_path` (string, required) and `reporter` (enum `["json","tap"]`, required).
    - `db_bridge`: schema has `action` (enum `["query","schema","seed"]`, required) and `payload` (string, required).
    - `capture_trace`: schema has `duration_ms` (integer, required, min 100, max 30000) and `type` (enum `["cpu","heap","network"]`, required).
    - `get_logs`: schema has `level` (enum `["debug","info","warn","error"]`, required), `limit` (integer, required, min 1, max 500), and `follow` (boolean, optional).
  - Assert that calling a tool with an invalid parameter (e.g. `db_bridge` with `action: "DROP"`) returns a JSON-RPC error with code `-32602` (Invalid params), not a crash.

- [ ] In `packages/devs-core/src/templates/__tests__/mcpNativeReadOnly.test.ts`, verify the read-only safety guarantee for `inspect_state` and `get_logs`:
  - Call `inspect_state` and verify the process state has not been modified (assert a sentinel value set before the call is unchanged after the call).
  - Call `get_logs` and verify no new log lines were written to the log file as a result of the call.

## 2. Task Implementation
- [ ] Update the `.agent/index.agent.md` template string in `ProjectServerTemplateScaffolder` to include the full AOD manifest:
  ```markdown
  # ProjectServer – Agent-Oriented Documentation (AOD)

  This MCP server is automatically injected into every project generated by `devs`.
  It provides standardized interfaces for introspection, debugging, and profiling
  per [3_MCP-TAS-003] and [4_USER_FEATURES-REQ-012].

  ## Tools

  | Tool | Parameters | Return Type | Description |
  |------|-----------|-------------|-------------|
  | `inspect_state` | `path: string`, `depth?: number (1-10, default 3)` | `{ value: unknown, error?: string }` | Reads internal memory, cache values, or singleton states of the running application. |
  | `run_test_task` | `test_path: string`, `reporter: "json" \| "tap"` | `StructuredTestReport` | Executes specific tests and returns machine-readable failure analysis. |
  | `db_bridge` | `action: "query" \| "schema" \| "seed"`, `payload: string` | `DBResult` | Direct access to the application's internal database for data-integrity verification. |
  | `capture_trace` | `duration_ms: number (100-30000)`, `type: "cpu" \| "heap" \| "network"` | `ProfileData` | Generates a performance snapshot for the Refactor phase. |
  | `get_logs` | `level: "debug" \| "info" \| "warn" \| "error"`, `limit: number (1-500)`, `follow?: boolean` | `LogEntry[]` | Streams structured application logs for runtime behavior analysis. |

  ## Introspection Points

  - **Process state** (`inspect_state`): Traverses `globalThis` or registered state singletons to expose live variable values.
  - **Test runner** (`run_test_task`): Spawns Vitest/Jest and parses structured JSON output for failure analysis.
  - **Database** (`db_bridge`): Opens the application's SQLite database for schema inspection, data queries, and seeding.
  - **CPU/Heap profiler** (`capture_trace`): Uses `v8-profiler-next` to capture runtime performance snapshots.
  - **Application logs** (`get_logs`): Reads and filters the application's NDJSON structured log file.

  ## Lifecycle

  - **Start**: The ProjectServer starts automatically when the `DeveloperAgent` enters Dev Mode
    (invokes `ProjectServerLifecycleManager.start()`). It performs an MCP `initialize` handshake
    before reporting ready.
  - **Stop**: The ProjectServer stops when Dev Mode exits. A SIGTERM is sent first; SIGKILL is
    issued after a 5-second grace period if the process has not exited.
  - **Crash recovery**: If the server exits unexpectedly, a `"projectserver:crash"` event is
    emitted on the lifecycle manager's event bus.

  ## Extension

  To add project-specific tools, create a new file in `mcp-server/src/tools/` and call
  `registerMyTool(server)` inside `registerAllTools()` in `mcp-server/src/tools/index.ts`.
  Update this manifest accordingly.
  ```

- [ ] Ensure each tool's `server.tool()` call includes a `description` string matching the `Description` column in the AOD manifest table, so the MCP `tools/list` response is self-documenting for agents.
- [ ] Add input schema `description` annotations to every Zod field in all five tool implementations (tasks 03) so the JSON Schema emitted by the MCP SDK is self-documenting:
  - Example: `z.string().describe("Dot-separated path to traverse globalThis (e.g. 'app.cache.users')")`.
- [ ] Set `minLength`/`maxLength` constraints on `inspect_state`'s `path` field (`minLength: 1`, `maxLength: 512`) to prevent path traversal abuse.

## 3. Code Review
- [ ] Verify that every tool's `description` in `server.tool()` matches its AOD manifest entry exactly (no divergence between what the manifest documents and what the SDK exposes).
- [ ] Verify all five Zod schemas include `.describe()` annotations on every field for self-documenting JSON Schema output.
- [ ] Verify the AOD manifest `.agent/index.agent.md` template is valid GitHub-Flavored Markdown (no broken table syntax, no trailing spaces in table cells causing rendering issues).
- [ ] Verify the `## Lifecycle` section accurately reflects the implementation in `ProjectServerLifecycleManager` (task 04)—no documentation drift.

## 4. Run Automated Tests to Verify
- [ ] Run `pnpm --filter @devs/core test -- --testPathPattern="aodManifest|mcpCapabilities|mcpNativeReadOnly"` and confirm all tests pass (exit code `0`).
- [ ] Run `pnpm --filter @devs/core build` to confirm zero TypeScript errors.

## 5. Update Documentation
- [ ] Update `docs/architecture/templates.md` with a `### AOD Manifest` section explaining the purpose of `.agent/index.agent.md` in the generated project and how AI agents use it to discover available introspection tools.
- [ ] Add a note to the project-level developer guide (`docs/contributing.md` or equivalent) that any new tool added to the ProjectServer template MUST have a corresponding entry in `.agent/index.agent.md`.

## 6. Automated Verification
- [ ] Validate the AOD manifest completeness with a script:
  ```bash
  node -e "
    const fs = require('fs');
    const manifest = fs.readFileSync('/tmp/mcp-scaffold-verify/mcp-server/.agent/index.agent.md', 'utf8');
    const tools = ['inspect_state','run_test_task','db_bridge','capture_trace','get_logs'];
    const sections = ['## Tools','## Introspection Points','## Lifecycle'];
    const missingTools = tools.filter(t => !manifest.includes(t));
    const missingSections = sections.filter(s => !manifest.includes(s));
    if (missingTools.length || missingSections.length) {
      console.error('FAIL - missing tools:', missingTools, 'missing sections:', missingSections);
      process.exit(1);
    }
    console.log('PASS: AOD manifest complete');
  "
  ```
- [ ] Run the `tools/list` assertion from task 03's verification script and additionally assert each tool entry has a non-empty `description` field:
  ```bash
  node -e "
    // ... (same spawn setup as task 03 verification)
    // After receiving tools/list response:
    const withoutDesc = toolsResp.result.tools.filter(t => !t.description || t.description.trim() === '');
    if (withoutDesc.length) { console.error('FAIL: tools missing description:', withoutDesc.map(t => t.name)); process.exit(1); }
    console.log('PASS: all tools have descriptions');
  "
  ```
