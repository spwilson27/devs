# Task: Implement Vulnerability Trigger and Task Failure Integration (Sub-Epic: 10_Vulnerability and Dependency Scanning)

## Covered Requirements
- [1_PRD-REQ-SEC-013], [5_SECURITY_DESIGN-REQ-SEC-SD-056]

## 1. Initial Test Written
- [ ] In `packages/orchestrator/src/security/__tests__/vulnerabilityTrigger.test.ts`, write unit tests for a new `VulnerabilityTrigger` class:
  - Test that `evaluate(report: AuditReport): VulnerabilityTriggerResult` returns `{ shouldFail: true, failureReason: string, requiredMitigations: MitigationAction[] }` when `report.hasCritical === true`.
  - Test that `evaluate` returns `{ shouldFail: true, ... }` when `report.hasHigh === true`.
  - Test that `evaluate` returns `{ shouldFail: false, failureReason: null, requiredMitigations: [] }` when the report has no high or critical vulnerabilities.
  - Test that `failureReason` includes the count and names of the high/critical packages.
  - Test that `requiredMitigations` contains one `MitigationAction` per vulnerability, each specifying `{ packageName, action: 'update' | 'remove' | 'patch', suggestedVersion?: string }`.
  - Test that `applyToTask(taskId: string, result: VulnerabilityTriggerResult): Promise<void>` updates the task record in the orchestrator's SQLite database:
    - Sets `tasks.status = 'failed'` for the given `taskId`.
    - Sets `tasks.failure_reason = result.failureReason`.
    - Inserts rows into a `security_mitigations` table for each `MitigationAction`.
  - Test that `applyToTask` emits an `orchestrator:task:vulnerability-failure` event on the event bus, carrying `{ taskId, vulnerabilities, mitigations }`.
  - Test that when `npm audit fix --force` is available and the fix is non-breaking (only patch versions), `MitigationAction.action` is set to `'patch'` and the suggested patched version is included.

## 2. Task Implementation
- [ ] Create `packages/orchestrator/src/security/vulnerabilityTrigger.ts`:
  - Define `MitigationAction` interface: `{ packageName: string; currentVersion: string; severity: string; action: 'update' | 'remove' | 'patch'; suggestedVersion?: string; cveId?: string; }`.
  - Define `VulnerabilityTriggerResult` interface: `{ shouldFail: boolean; failureReason: string | null; requiredMitigations: MitigationAction[]; }`.
  - Implement `class VulnerabilityTrigger`:
    - `evaluate(report: AuditReport): VulnerabilityTriggerResult` — filters `report.vulnerabilities` to only `high` and `critical`, builds `failureReason` as a formatted multi-line string listing each package, severity, and CVE ID, and constructs `requiredMitigations`.
    - `async applyToTask(taskId: string, result: VulnerabilityTriggerResult, db: DatabaseService, eventBus: EventBus): Promise<void>` — executes a SQLite transaction:
      1. `UPDATE tasks SET status='failed', failure_reason=?, updated_at=? WHERE id=?`
      2. `INSERT INTO security_mitigations (task_id, package_name, severity, action, suggested_version, cve_id, created_at) VALUES (...)` for each mitigation.
      3. Emits `orchestrator:task:vulnerability-failure` event.
- [ ] Create a SQLite migration file `packages/orchestrator/migrations/XXXX_add_security_mitigations_table.sql`:
  ```sql
  CREATE TABLE IF NOT EXISTS security_mitigations (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    task_id TEXT NOT NULL REFERENCES tasks(id),
    package_name TEXT NOT NULL,
    severity TEXT NOT NULL,
    action TEXT NOT NULL,
    suggested_version TEXT,
    cve_id TEXT,
    created_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now'))
  );
  CREATE INDEX idx_security_mitigations_task_id ON security_mitigations(task_id);
  ```
- [ ] Integrate `VulnerabilityTrigger` into the orchestrator pipeline step that calls `AuditGate.runAudit()`: after receiving the `AuditReport`, call `trigger.evaluate(report)`, and if `result.shouldFail` is `true`, call `trigger.applyToTask(...)` and throw a `TaskFailureError` with `cause: result.failureReason` to halt pipeline execution.
- [ ] Update the task status state machine in `packages/orchestrator/src/pipeline/taskStateMachine.ts` (or equivalent) to include a `'vulnerability-failed'` terminal state distinct from generic `'failed'` to allow the UI to display a specific remediation flow.

## 3. Code Review
- [ ] Verify the SQLite transaction in `applyToTask` is wrapped in `BEGIN IMMEDIATE ... COMMIT` so that the status update and mitigation inserts are atomic.
- [ ] Confirm the `'vulnerability-failed'` task state is handled in the task state machine's valid transitions and does not allow re-execution without explicit user approval.
- [ ] Verify the `failureReason` string is truncated to a reasonable length (e.g., ≤ 2048 characters) before being written to the database to prevent schema issues.
- [ ] Confirm the event emitted on the event bus uses the canonical event name `orchestrator:task:vulnerability-failure` and that the event payload schema is documented.
- [ ] Ensure `VulnerabilityTrigger` is stateless (no mutable instance fields) so it can be safely reused across concurrent pipeline runs.
- [ ] Confirm all new exports appear in `packages/orchestrator/src/security/index.ts`.

## 4. Run Automated Tests to Verify
- [ ] Run `pnpm --filter orchestrator test --testPathPattern=vulnerabilityTrigger` and confirm all tests pass.
- [ ] Run `pnpm --filter orchestrator test --coverage` and confirm `vulnerabilityTrigger.ts` line coverage ≥ 90%.
- [ ] Run the full orchestrator test suite `pnpm --filter orchestrator test` and confirm no regressions.
- [ ] Run `pnpm --filter orchestrator db:migrate` (or equivalent migration command) against a test database and confirm the `security_mitigations` table is created without errors.

## 5. Update Documentation
- [ ] Add a section to `docs/security.md` titled **"Vulnerability Trigger & Task Failure"** describing: the severity threshold (High/Critical), the failure flow, the `security_mitigations` table schema, and the event emitted.
- [ ] Update `docs/pipeline.md` (or equivalent) to document the `vulnerability-failed` task state and how a user can review and remediate before re-running.
- [ ] Add inline comment above the `evaluate` method: `// [1_PRD-REQ-SEC-013] [5_SECURITY_DESIGN-REQ-SEC-SD-056]: High/Critical vulnerabilities trigger task failure and populate mitigation actions.`

## 6. Automated Verification
- [ ] Run `pnpm --filter orchestrator test --testPathPattern=vulnerabilityTrigger --passWithNoTests=false` and assert exit code is `0`.
- [ ] Run `grep -r "1_PRD-REQ-SEC-013" packages/orchestrator/src/security/vulnerabilityTrigger.ts` and confirm the requirement tag is present.
- [ ] Run `grep -r "5_SECURITY_DESIGN-REQ-SEC-SD-056" packages/orchestrator/src/security/vulnerabilityTrigger.ts` and confirm the requirement tag is present.
- [ ] Run `sqlite3 <test_db_path> ".schema security_mitigations"` and confirm the table schema includes all required columns.
