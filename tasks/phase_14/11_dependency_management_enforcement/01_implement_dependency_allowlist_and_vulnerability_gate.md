# Task: Implement Dependency Allowlist and Automated Vulnerability Gate (Sub-Epic: 11_Dependency Management Enforcement)

## Covered Requirements
- [1_PRD-REQ-CON-005]

## 1. Initial Test Written

- [ ] In `src/security/__tests__/dependencyPolicy.test.ts`, write unit tests for a `DependencyPolicyEngine` class covering:
  - `isPackageAllowed(packageName: string, version: string): boolean` — returns `true` for packages on the explicit allowlist, `false` for unknown packages, and `false` for packages explicitly blocklisted.
  - `scanManifest(manifestPath: string): Promise<DependencyScanResult>` — resolves with `{ violations: ScanViolation[], passed: boolean }`. Test that it returns `passed: false` when a blocklisted package is present in `package.json`.
  - `enforceAtInstallTime(proposedDeps: Record<string, string>): Promise<void>` — rejects with a typed `DependencyViolationError` if any proposed dependency is not on the allowlist or has a known CVE.
- [ ] In `src/security/__tests__/dependencyPolicy.integration.test.ts`, write integration tests that:
  - Create a temporary directory with a fixture `package.json` containing a mix of allowed and blocklisted packages.
  - Call `scanManifest()` against the fixture and assert `violations` array contains exactly the expected blocked packages.
  - Assert that the `CVECheckClient` (mocked via `jest.mock`) is invoked once per unique dependency.
- [ ] Write a test asserting that the engine reads allowlist configuration from `devs.config.json` under the key `"dependencyPolicy.allowlist"` and that missing config falls back to a built-in default allowlist.

## 2. Task Implementation

- [ ] Create `src/security/dependencyPolicy.ts` exporting `DependencyPolicyEngine`:
  - Constructor accepts `config: DependencyPolicyConfig` (loaded from `devs.config.json` → `dependencyPolicy` block).
  - `allowlist: Set<string>` populated from `config.allowlist` plus the built-in defaults from `src/security/defaultAllowlist.ts`.
  - `blocklist: Set<string>` populated from `config.blocklist` (if present).
- [ ] Create `src/security/defaultAllowlist.ts` exporting a curated `DEFAULT_ALLOWED_PACKAGES: string[]` that covers the core devs runtime dependencies (e.g., `typescript`, `zod`, `lancedb`, `better-sqlite3`, etc.).
- [ ] Implement `isPackageAllowed`: return `false` immediately if the name is in `blocklist`; return `true` only if in `allowlist`.
- [ ] Implement `scanManifest(manifestPath)`:
  - Parse `package.json` at the given path using `fs/promises`.
  - Merge `dependencies` and `devDependencies` keys.
  - For each package, call `isPackageAllowed` and, for allowed packages, call `this.cveClient.check(name, version)`.
  - Accumulate `ScanViolation` objects: `{ package, version, reason: 'NOT_ALLOWLISTED' | 'KNOWN_CVE', cveIds?: string[] }`.
  - Return `{ violations, passed: violations.length === 0 }`.
- [ ] Create `src/security/cveCheckClient.ts` wrapping the `npm audit --json` subprocess call (via `child_process.execFile`) and parsing the JSON output to extract CVE identifiers per package name.
- [ ] Implement `enforceAtInstallTime(proposedDeps)`:
  - Write a temporary `package.json` to a temp dir.
  - Call `scanManifest` against it.
  - If `!passed`, throw `new DependencyViolationError(violations)`.
- [ ] Register the enforcement hook in `src/agents/taskExecutor.ts`: before any agent calls `installDependencies()`, call `dependencyPolicyEngine.enforceAtInstallTime(proposedDeps)`. If it throws, abort the task and surface the error to the orchestrator.
- [ ] Add `dependencyPolicy` block to `devs.config.json` schema in `src/config/schema.ts` with fields: `allowlist: string[]`, `blocklist: string[]`, `cveCheckEnabled: boolean`.
- [ ] Expose a CLI sub-command `devs deps audit [project-dir]` in `src/cli/commands/depsAudit.ts` that calls `scanManifest` on the target project and prints a human-readable report with exit code 1 on failure.

## 3. Code Review

- [ ] Verify `DependencyPolicyEngine` is a pure, injectable class (no global singletons) so it is easily testable and mockable.
- [ ] Confirm `CVECheckClient` is behind an interface (`ICVECheckClient`) to allow mocking in unit tests without spawning real `npm audit` subprocesses.
- [ ] Ensure the `enforceAtInstallTime` path is wrapped in a try/catch that surfaces structured errors (not raw stderr strings) to the orchestrator.
- [ ] Confirm the allowlist/blocklist logic is O(1) via `Set` membership, not linear array search.
- [ ] Ensure no host credentials or `process.env` variables are logged or included in violation reports.
- [ ] Verify the `devs deps audit` command prints machine-readable JSON when `--json` flag is passed, suitable for CI consumption.

## 4. Run Automated Tests to Verify

- [ ] Run `npx jest src/security/__tests__/dependencyPolicy.test.ts --coverage` and confirm all tests pass with ≥90% branch coverage on `dependencyPolicy.ts`.
- [ ] Run `npx jest src/security/__tests__/dependencyPolicy.integration.test.ts` and confirm all integration tests pass.
- [ ] Run `npx jest --testPathPattern="security"` to ensure no existing security tests are regressed.
- [ ] Run `npx tsc --noEmit` to confirm no TypeScript type errors.

## 5. Update Documentation

- [ ] Update `docs/security.md` with a new section **"Dependency Management Policy"** describing: the allowlist/blocklist mechanism, how to extend the allowlist in `devs.config.json`, and how the `devs deps audit` command works.
- [ ] Update `docs/cli-reference.md` with the `devs deps audit` command signature, flags, and example output.
- [ ] Add an entry to `docs/agent-memory/phase_14_decisions.md` recording: "Dependency enforcement uses an explicit allowlist backed by `npm audit` CVE checks, enforced at agent install-time via `DependencyPolicyEngine`."

## 6. Automated Verification

- [ ] Run `bash scripts/validate-all.sh` and confirm the dependency policy tests are included in the test suite output with zero failures.
- [ ] Run `node dist/cli.js deps audit fixtures/test-project/ --json` against the fixture project containing a known-bad dependency and assert the process exits with code 1 and the JSON output contains the expected `violations` array.
- [ ] Confirm CI workflow `ci.yml` includes a `devs deps audit` step and that removing a package from the allowlist causes the step to fail.
