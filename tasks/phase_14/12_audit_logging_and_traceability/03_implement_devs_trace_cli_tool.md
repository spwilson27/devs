# Task: Implement `devs trace` Command-Line Auditing Tool (Sub-Epic: 12_Audit Logging and Traceability)

## Covered Requirements
- [5_SECURITY_DESIGN-REQ-SEC-SD-077]

## 1. Initial Test Written

- [ ] Create `src/cli/commands/__tests__/TraceCommand.test.ts` using Vitest.
- [ ] Write a unit test for `TraceCommand.fetchTaskTrace(db: Database, taskId: string): Promise<TaskTrace>` — mock the SQLite `Database` to return synthetic rows for the given `taskId` from the `agent_logs`, `tasks`, and `entropy_events` tables. Assert the returned `TaskTrace` object contains:
  - `task: { id, title, status, git_commit_hash, requirementIds }`
  - `agentLogs: Array<{ turn: number, agentRole: string, summary: string, timestamp: string }>`
  - `entropyEvents: Array<{ turn: number, description: string, timestamp: string }>`
- [ ] Write a unit test for `TraceCommand.renderMarkdown(trace: TaskTrace): string` — given a fixed `TaskTrace` fixture, assert the output string:
  - Starts with a `# Trace: <task.title>` heading.
  - Contains a `## Task Details` section with `id`, `status`, `git_commit_hash`, and a list of `requirementIds` as bullet points.
  - Contains an `## Agent Reasoning Log` section with each `agentLog` formatted as `### Turn N — <agentRole>\n<summary>`.
  - Contains an `## Entropy Events` section if `entropyEvents` is non-empty.
  - Ends with a `---\n*Generated by devs trace at <UTC timestamp>*` footer.
- [ ] Write a unit test for `TraceCommand.run(args: string[]): Promise<void>` — mock `fetchTaskTrace` and `renderMarkdown`. Verify that when `--output <file>` is passed, `fs.writeFile` is called with the rendered Markdown. When no `--output` flag is present, assert `process.stdout.write` is called instead.
- [ ] Write an E2E CLI test: spin up a temp `state.sqlite` with pre-seeded task and agent_logs data, invoke the CLI subprocess `node dist/cli.js trace <taskId>` and capture stdout, assert it contains the expected Markdown headings.

## 2. Task Implementation

- [ ] Register a new `trace` subcommand in `src/cli/commands/TraceCommand.ts`. The command signature is:
  ```
  devs trace <taskId> [--output <filepath>] [--format markdown]
  ```
- [ ] Implement `TraceCommand.fetchTaskTrace(db: Database, taskId: string): Promise<TaskTrace>`:
  - Query `SELECT * FROM tasks WHERE id = ?`.
  - Query `SELECT turn, agent_role, summary, created_at FROM agent_logs WHERE task_id = ? ORDER BY turn ASC`.
  - Query `SELECT turn, description, created_at FROM entropy_events WHERE task_id = ? ORDER BY turn ASC`.
  - Parse the `tasks.requirement_ids` column (stored as JSON array string) into `string[]`.
  - Return a structured `TaskTrace` object.
- [ ] Implement `TraceCommand.renderMarkdown(trace: TaskTrace): string` as a pure function (no I/O) producing the Markdown document described in the test spec.
- [ ] Implement `TraceCommand.run(args: string[]): Promise<void>`:
  - Parse `args` using the project's existing argument parser (e.g., `minimist`).
  - Open `state.sqlite` via the project's `DatabaseFactory`.
  - Call `fetchTaskTrace`, then `renderMarkdown`.
  - If `--output <path>` provided, write to file; otherwise write to `process.stdout`.
- [ ] Wire the `trace` command into the CLI router in `src/cli/index.ts`.
- [ ] Add `// [5_SECURITY_DESIGN-REQ-SEC-SD-077]` inline comment above the `TraceCommand` class declaration.
- [ ] Define the `TaskTrace` interface in `src/tracing/types.ts`:
  ```typescript
  export interface TaskTrace {
    task: {
      id: string;
      title: string;
      status: string;
      git_commit_hash: string | null;
      requirementIds: string[];
    };
    agentLogs: Array<{ turn: number; agentRole: string; summary: string; timestamp: string }>;
    entropyEvents: Array<{ turn: number; description: string; timestamp: string }>;
  }
  ```

## 3. Code Review

- [ ] Confirm `renderMarkdown` is a pure function with no side effects — it must not call `fs` or `process.stdout` directly.
- [ ] Verify the `--output` flag path is sanitized: reject paths outside the project directory using `path.resolve` + project root prefix check to prevent path traversal.
- [ ] Ensure `agent_logs.summary` column does not expose raw secrets — confirm `TokenRedactor` has been applied to `summary` at log-write time (not at read time). If not, apply `TokenRedactor.redact(summary)` before rendering.
- [ ] Confirm the command prints a clear error and exits with code 1 if the `taskId` does not exist in the database.
- [ ] Check TypeScript strict mode compliance.

## 4. Run Automated Tests to Verify

- [ ] Run `npm run test -- src/cli/commands/__tests__/TraceCommand.test.ts` — all unit tests pass.
- [ ] Run the E2E CLI test via `npm run test:e2e -- trace` — passes with correct Markdown output.
- [ ] Run `npm run lint` and `npm run typecheck` — zero errors.

## 5. Update Documentation

- [ ] Create `src/cli/commands/TraceCommand.agent.md` with:
  - Command usage: `devs trace <taskId> [--output <file>]`.
  - Output format: GitHub-Flavored Markdown with task details, agent reasoning log, and entropy events.
  - Security note: all `agent_logs.summary` values are pre-redacted at write time via `TokenRedactor`.
  - Covered requirement: `[5_SECURITY_DESIGN-REQ-SEC-SD-077]`.
- [ ] Update `docs/cli-reference.md` with a `## devs trace` section documenting all flags and example output.

## 6. Automated Verification

- [ ] Run `node scripts/validate-all.js --check TraceCommand` — the script must assert:
  1. `src/cli/commands/TraceCommand.ts` exists and exports a `TraceCommand` class.
  2. `src/cli/commands/TraceCommand.agent.md` exists (AOD density check).
  3. All tests in `src/cli/commands/__tests__/` pass via `vitest run`.
  4. The string `// [5_SECURITY_DESIGN-REQ-SEC-SD-077]` appears in `src/cli/commands/TraceCommand.ts`.
  5. Running `node dist/cli.js trace --help` exits with code 0 and stdout contains `devs trace`.
