# Task: Implement Technology and User Research Report Generators (Sub-Epic: 10_Report Generation Engine)

## Covered Requirements
- [9_ROADMAP-TAS-305], [1_PRD-REQ-MAP-003], [1_PRD-REQ-NEED-DOMAIN-01]

## 1. Initial Test Written
- [ ] Create `src/agents/research/reports/__tests__/technology_report_generator.test.ts`.
- [ ] Write unit tests for `TechnologyReportGenerator` asserting:
  - `generate(data: TechnologyReportData): Promise<ReportDocument>` resolves with `reportType === 'technology'`.
  - The `markdownContent` contains a `## Technology Overview` section.
  - The `markdownContent` contains a `## Decision Matrix` section that embeds the GFM table from `TechDecisionMatrixGenerator.toMarkdownTable()`.
  - The `markdownContent` contains a `## Decision Matrix Visualization` section with a Mermaid `xychart-beta` block from `TechDecisionMatrixGenerator.toMermaidXYChart()`.
  - The `markdownContent` contains a `## Pros & Cons` section generated by `TechDecisionMatrixGenerator.toProsConsMarkdown()` (satisfying `[1_PRD-REQ-MAP-003]`).
  - The `markdownContent` contains a `## Trade-offs` section.
  - The `markdownContent` contains a `## Why We Chose {recommendedOption.name}` section populated from `data.rationale` explaining the "Why" (satisfying `[1_PRD-REQ-NEED-DOMAIN-01]`).
  - The `markdownContent` contains a `## Sources` section.
  - Calling `generate()` with a `DecisionMatrixData` where weights do not sum to 1.0 causes the promise to reject with a `WeightValidationError`.
- [ ] Create `src/agents/research/reports/__tests__/user_research_report_generator.test.ts`.
- [ ] Write unit tests for `UserResearchReportGenerator` asserting:
  - `generate(data: UserResearchReportData): Promise<ReportDocument>` resolves with `reportType === 'user_research'`.
  - The `markdownContent` contains a `## User Personas` section with one `### Persona: {persona.name}` subsection per persona in `data.personas` (minimum 3 personas enforced: a `PersonaCountError` is thrown if `data.personas.length < 3`).
  - Each persona subsection includes `**Role:**`, `**Goals:**` (bullet list), `**Pain Points:**` (bullet list), and `**Key Behaviour:**` fields.
  - The `markdownContent` contains a `## User Journey Maps` section with one Mermaid `sequenceDiagram` block per journey in `data.journeys`, labelled `### Journey: {journey.name}`.
  - The `markdownContent` contains `## Pros & Cons` and `## Trade-offs` sections (satisfying `[1_PRD-REQ-MAP-003]`).
  - The `markdownContent` contains a `## Sources` section.
  - A Mermaid `sequenceDiagram` with `steps` array of `{actor, action, target}` produces correctly formatted `actor->>target: action` lines.

## 2. Task Implementation
- [ ] Create `src/agents/research/reports/technology_report_generator.ts`.
- [ ] Define and export `TechnologyReportData` interface:
  ```typescript
  export interface TechnologyReportData extends ReportData {
    type: 'technology';
    projectName: string;
    overview: string;
    matrixData: DecisionMatrixData;
    rationale: string;
    tradeoffs: string[];
    sources: Array<{ title: string; url: string; credibilityScore: number }>;
  }
  ```
- [ ] Implement `TechnologyReportGenerator extends BaseReportGenerator` with `generate(data: TechnologyReportData): Promise<ReportDocument>`:
  - Call `TechDecisionMatrixGenerator.generate(data.matrixData)` (propagate `WeightValidationError` on rejection).
  - Build sections: Technology Overview, Decision Matrix (GFM table), Decision Matrix Visualization (Mermaid XY chart), Pros & Cons, Trade-offs, Why We Chose `{recommendedOption.name}` (content from `data.rationale`), Sources.
- [ ] Create `src/agents/research/reports/user_research_report_generator.ts`.
- [ ] Define and export the following interfaces:
  ```typescript
  export interface UserPersona { name: string; role: string; goals: string[]; painPoints: string[]; keyBehaviour: string; }
  export interface JourneyStep { actor: string; action: string; target: string; }
  export interface UserJourney { name: string; steps: JourneyStep[]; }
  export interface UserResearchReportData extends ReportData {
    type: 'user_research';
    projectName: string;
    personas: UserPersona[];
    journeys: UserJourney[];
    pros: string[];
    cons: string[];
    tradeoffs: string[];
    sources: Array<{ title: string; url: string; credibilityScore: number }>;
  }
  export class PersonaCountError extends Error { constructor(count: number) { super(`Minimum 3 personas required, got ${count}`); this.name = 'PersonaCountError'; } }
  ```
- [ ] Implement `UserResearchReportGenerator extends BaseReportGenerator` with `generate(data: UserResearchReportData): Promise<ReportDocument>`:
  - Throw `PersonaCountError` synchronously if `data.personas.length < 3`.
  - Build sections: User Personas (one subsection per persona), User Journey Maps (one Mermaid `sequenceDiagram` per journey), Pros & Cons, Trade-offs, Sources.
  - Each `sequenceDiagram` block formatted as:
    ```
    ```mermaid
    sequenceDiagram
        {actor}->>{target}: {action}
    ```
    ```
- [ ] Register both generators in `ReportGeneratorFactory.create()` for types `'technology'` and `'user_research'`.
- [ ] Export all new symbols from `src/agents/research/reports/index.ts`.

## 3. Code Review
- [ ] Confirm `TechnologyReportGenerator` delegates all matrix computations to `TechDecisionMatrixGenerator` (no reimplementation of scoring logic).
- [ ] Confirm the `## Why We Chose` section heading is dynamically interpolated from `recommendedOption.name`, not hardcoded.
- [ ] Confirm `PersonaCountError` is thrown synchronously before any async work begins.
- [ ] Confirm each Mermaid `sequenceDiagram` block is fenced with ` ```mermaid` and ` ``` `.
- [ ] Confirm `## Pros & Cons` and `## Trade-offs` headings appear in both report types (required by `[1_PRD-REQ-MAP-003]`).
- [ ] Confirm all four report types are now registered and `ReportGeneratorFactory.create()` handles all of `'market' | 'competitive' | 'technology' | 'user_research'`.

## 4. Run Automated Tests to Verify
- [ ] Run `npm test -- --testPathPattern="(technology_report_generator|user_research_report_generator)"` and confirm all tests pass.
- [ ] Run `npm run type-check` and confirm zero TypeScript errors.

## 5. Update Documentation
- [ ] Append `### Technology Report Generator` and `### User Research Report Generator` subsections to `docs/architecture/research_agents.md`.
- [ ] Document `PersonaCountError` and the minimum 3-persona requirement.
- [ ] Update `docs/agent_memory/phase_5_decisions.md` with: "Technology reports embed decision matrix tables and XY charts inline. User research reports require â‰¥3 personas and include one Mermaid `sequenceDiagram` per journey. `PersonaCountError` thrown synchronously if count < 3."

## 6. Automated Verification
- [ ] Run `npm test -- --testPathPattern="(technology_report_generator|user_research_report_generator)" --passWithNoTests=false` and assert exit code is `0`.
- [ ] Run `npx tsc --noEmit` and assert exit code is `0`.
- [ ] Run `node -e "const {ReportGeneratorFactory} = require('./dist/agents/research/reports'); ['market','competitive','technology','user_research'].forEach(t => { const g = ReportGeneratorFactory.create(t); console.assert(g !== null, t); });"` and assert exit code is `0`.
