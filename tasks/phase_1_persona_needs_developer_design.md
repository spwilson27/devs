# Tasks for Persona Needs: Developer & Design (Phase: phase_1.md)

## Covered Requirements
- [REQ-NEED-ARCH-02], [REQ-NEED-ARCH-03], [REQ-NEED-DEVS-01], [REQ-NEED-DEVS-02], [REQ-NEED-DEVS-03]

### Task Checklist
- [ ] **Subtask 1: Document Approval State Management (REQ-NEED-ARCH-02)**: Update `scripts/gen_all.py` and `scripts/.gen_state.json` to include an `approved_docs` list. Implement a CLI utility `scripts/approve.py` that allows a user to mark a specific document ID as "approved". Modify the `gen_all.py` workflow to block the transition from the "Document Generation" phase to the "Requirements Distillation" phase unless both `1_prd` and `2_tas` are present in the `approved_docs` list.
- [ ] **Subtask 2: Automated Architecture & Security Reviewer Agent (REQ-NEED-ARCH-03)**: Create a new agent prompt template `scripts/prompts/reviewer_agent.md` that instructs the AI to act as a Senior Security Architect. It must look for anti-patterns (e.g., tight coupling, lack of error handling) and security flaws (e.g., hardcoded secrets, open network egress). Integrate this agent into the `gen_all.py` pipeline to run automatically after each document is generated. Store the review report in `reports/reviews/{doc_id}_review.md`.
- [ ] **Subtask 3: Agent-to-Agent Communication Tracing (REQ-NEED-DEVS-01)**: Implement a logging wrapper around the Gemini CLI calls in `GeminiRunner.run()`. This wrapper must append every prompt and response to a `.gemini/traces.jsonl` file. Each entry must include: `timestamp`, `sender_id`, `receiver_id` (always 'gemini' for now), `prompt_tokens`, `completion_tokens`, `total_tokens`, and the full text of the exchange. Ensure the `.gemini` directory exists and is excluded from document generation prompts via `.geminiignore`.
- [ ] **Subtask 4: Workspace Snapshotting & Time-Travel (REQ-NEED-DEVS-02)**: Create `scripts/checkpoint.py` which creates a compressed tarball of the current workspace (excluding `.git`, `node_modules`, and `.gemini/checkpoints`) and saves it to `.gemini/checkpoints/{timestamp}_{last_task_id}.tar.gz`. Implement `scripts/rewind.py` which lists available checkpoints and allows the user to restore the workspace to a specific point in time, effectively "rewinding" the project state.
- [ ] **Subtask 5: System-Wide Token & Latency Profiler (REQ-NEED-DEVS-03)**: Develop `scripts/profile.py` which parses `.gemini/traces.jsonl` and `scripts/.gen_state.json`. It should generate a Markdown report (`reports/profiling_report.md`) that identifies: 1) The most "expensive" document in terms of total tokens, 2) The "slowest" phase based on timestamps, and 3) Average token usage per agent role. This report must be updated at the end of every phase.

### Testing & Verification
- [ ] **Verification 1: Approval Gate Test**: Manually generate a PRD and attempt to run the next phase without approval. Verify that `gen_all.py` exits with a clear "Approval Required" message. Then run `scripts/approve.py 1_prd` and verify it proceeds.
- [ ] **Verification 2: Reviewer Agent Output**: Inspect `reports/reviews/` after a generation run and ensure Markdown files exist with specific "Security" and "Architecture" sections.
- [ ] **Verification 3: Trace Integrity Check**: Run a task and verify that `.gemini/traces.jsonl` contains the exact prompt used and the response received, along with valid token counts.
- [ ] **Verification 4: Rewind Functional Test**: Create a dummy file `test_rewind.txt`, create a checkpoint, delete the file, and run `scripts/rewind.py`. Verify the file is restored and the `gen_state.json` matches the checkpointed version.
- [ ] **Verification 5: Profiler Accuracy**: Run `scripts/profile.py` and verify that the math for total tokens matches the sum of entries in the trace log.
