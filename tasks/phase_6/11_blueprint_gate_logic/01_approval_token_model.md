# Task: Implement ApprovalToken DB model and migration (Sub-Epic: 11_Blueprint Gate Logic)

## Covered Requirements
- [9_ROADMAP-TAS-404], [9_ROADMAP-REQ-008]

## 1. Initial Test Written
- [ ] Create unit tests with the project's test runner (prefer pytest) at tests/unit/test_approval_token_model.py. Tests to write first:
  - test_create_persists: call ApprovalToken.create(document_path, phase, created_by) and assert a DB row exists with status 'pending' and correct document_path.
  - test_unique_token: attempt to insert two tokens with the same token string and assert a uniqueness constraint error is raised.
  - test_is_expired: create a token with expires_at in the past and assert token.is_expired() returns True.
  - test_checksum_generation: create a small sample blueprint file in a tmpdir, call ApprovalToken.create with compute_checksum flag, and assert stored checksum == hashlib.sha256(file_bytes).hexdigest().
  - test_mark_approved_updates_fields: call ApprovalToken.mark_approved(approver) and assert status == 'approved' and approved_by and approved_at populated.

## 2. Task Implementation
- [ ] Implement DB migration and ORM model:
  - Add reversible migration migrations/000X_create_approval_tokens.sql (or an alembic/autogenerated migration) that creates table `approval_tokens` with columns:
    - id UUID PRIMARY KEY
    - token VARCHAR UNIQUE NOT NULL
    - phase VARCHAR NOT NULL
    - document_path VARCHAR NOT NULL
    - status VARCHAR(20) DEFAULT 'pending' CHECK(status IN ('pending','approved','rejected'))
    - created_by VARCHAR
    - approved_by VARCHAR NULL
    - checksum VARCHAR(128) NULL
    - created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
    - approved_at TIMESTAMP WITH TIME ZONE NULL
    - expires_at TIMESTAMP WITH TIME ZONE NULL
    - metadata JSONB NULL (optional)
    - indexes on (token), (phase)
  - Implement an ORM model `ApprovalToken` at src/agents/approval_token.py with typed fields and the following methods:
    - create(document_path: str, phase: str, created_by: str, expires_at: Optional[datetime]=None, metadata: Optional[dict]=None) -> ApprovalToken
    - get_by_token(token: str) -> Optional[ApprovalToken]
    - mark_approved(approver: str) -> ApprovalToken
    - is_expired() -> bool
    - compute_and_store_checksum(document_path: str) -> str
  - Token generation: use os.urandom(32) then base64-url encode, and HMAC-SHA256 sign the token using a server-side secret from config (CONFIG.APPROVAL_SECRET). Persist only signed token or both raw+sig per security review.
  - Use the project's DB abstraction (SQLAlchemy session or existing DB helper). Add factories in tests/factories/approval_token_factory.py to simplify tests.

## 3. Code Review
- [ ] During self-review ensure:
  - migrations are reversible and idempotent
  - token generation uses secure randomness and HMAC signing (no predictable tokens)
  - no secrets are hard-coded; use config/ENV
  - indices exist for efficient lookup
  - model methods are small, single-responsibility, and fully unit-tested
  - any JSON/metadata fields are validated and limited in size

## 4. Run Automated Tests to Verify
- [ ] Run the new unit tests with the project's test runner (e.g., pytest -q tests/unit/test_approval_token_model.py). Use the test DB (in-memory sqlite or test postgres) and confirm all tests pass.

## 5. Update Documentation
- [ ] Add docs/blueprint-gate/approval_token.md that documents the schema, fields, lifecycle (pending -> approved/rejected), configuration (APPROVAL_SECRET, default TTL), and developer examples for creating and querying tokens. Add a small mermaid sequence diagram showing: ArchitectAgent -> API -> ApprovalToken.created -> Review Dashboard -> Approver -> ApprovalToken.mark_approved.

## 6. Automated Verification
- [ ] Provide a verification script scripts/verify_approval_token.sh (or Python script scripts/verify_approval_token.py) that:
  - creates a token via the model factory
  - reads it back from the DB and asserts the stored checksum matches a computed checksum for a sample doc
  - attempts to mark it approved and asserts status transition
  - exits non-zero on any mismatch. CI should call this script as a sanity check for gate components.
