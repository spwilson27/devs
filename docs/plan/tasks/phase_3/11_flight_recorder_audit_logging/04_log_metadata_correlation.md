# Task: Implement Log Metadata Correlation (thread_id, task_id, agent_role, turn_index, git_commit_hash) (Sub-Epic: 11_Flight Recorder & Audit Logging)

## Covered Requirements
- [5_SECURITY_DESIGN-REQ-SEC-SD-066]

## 1. Initial Test Written
- [ ] In `packages/core/src/flight-recorder/__tests__/metadataCorrelation.test.ts`, write unit tests that:
  - Assert every row inserted into `agent_logs` by `persistSaopTurn()` contains non-null, non-empty values for `thread_id`, `task_id`, `agent_role`, and `turn_index`.
  - Assert that `git_commit_hash` is populated with the current HEAD SHA when a Git repo is present and the field is `NULL` only when the process runs outside a Git repo (verify with a mock that simulates a missing `.git` directory).
  - Assert that `agent_role` is one of the allowed enum values (`ORCHESTRATOR`, `DEVELOPER`, `REVIEWER`, `ARCHITECT`) — inserting an unknown role must throw a `FlightRecorderError`.
  - Assert that `turn_index` is a non-negative integer and strictly monotonically increases per `(thread_id, task_id)` pair across consecutive `persistSaopTurn()` calls.
  - Assert that all metadata fields are **set at call time** (not lazily populated) — mock the Git resolver and confirm it is called synchronously before the INSERT.
- [ ] In `packages/core/src/flight-recorder/__tests__/metadataCorrelation.integration.test.ts`, write an integration test that:
  - Inserts 5 turns with varying `thread_id`, `task_id`, `agent_role` values.
  - Queries `SELECT DISTINCT thread_id, task_id, agent_role FROM agent_logs` and asserts the result matches the inputs exactly.
  - Queries for `git_commit_hash IS NOT NULL` rows and asserts the hash is a valid 40-character hex string.

## 2. Task Implementation
- [ ] Create `packages/core/src/flight-recorder/metadataResolver.ts` exporting:
  - `resolveGitCommitHash(repoRoot: string): Promise<string | null>`: Shells out to `git -C <repoRoot> rev-parse HEAD` (using `child_process.execFile` — not `exec`), returns the trimmed 40-char SHA or `null` on failure (no throw).
  - `AgentRole` enum: `ORCHESTRATOR | DEVELOPER | REVIEWER | ARCHITECT`.
  - `buildTurnContext(params: { threadId: string; taskId: string; agentRole: AgentRole; turnIndex: number; repoRoot: string }): Promise<TurnContext>`: Calls `resolveGitCommitHash()` and assembles the `TurnContext` object.
- [ ] Update `packages/core/src/flight-recorder/saopPersistence.ts` (from Task 02):
  - Accept `TurnContext` (which now includes `gitCommitHash: string | null`) and map it directly to the `agent_logs` INSERT — no additional resolution needed inside `persistSaopTurn`.
  - Add a runtime check: if `agentRole` is not a member of the `AgentRole` enum, throw `FlightRecorderError('Unknown agent_role: <value>')`.
- [ ] Add JSDoc on all exports referencing `[5_SECURITY_DESIGN-REQ-SEC-SD-066]`.

## 3. Code Review
- [ ] Confirm `resolveGitCommitHash` uses `execFile` (not `exec`) to prevent shell injection.
- [ ] Confirm `agent_role` validation happens **before** the INSERT, not after.
- [ ] Confirm `git_commit_hash` is stored as the full 40-char hex string, not abbreviated.
- [ ] Confirm the `TurnContext` type is the single source of truth for metadata — no metadata is derived inside the persistence layer (separation of concerns).
- [ ] Confirm that `turn_index` is sourced from the SAOP envelope's `turn_index` field, not auto-generated by the database.

## 4. Run Automated Tests to Verify
- [ ] Run `pnpm --filter @devs/core test -- --testPathPattern="metadataCorrelation"` and confirm all unit and integration tests pass.
- [ ] Run `pnpm --filter @devs/core build` and confirm no TypeScript errors.

## 5. Update Documentation
- [ ] Update `docs/architecture/flight-recorder.md` with a section **Metadata Correlation**: list all 5 metadata fields (`thread_id`, `task_id`, `agent_role`, `turn_index`, `git_commit_hash`) and describe how they enable cross-cutting queries (e.g., "all turns by DEVELOPER agent on task X").
- [ ] Update `docs/agent-memory/short-term.md` to reference `buildTurnContext` as the required entry point for constructing `TurnContext`, noting that `git_commit_hash` enables commit-to-reasoning trace linkage per `[5_SECURITY_DESIGN-REQ-SEC-SD-066]`.

## 6. Automated Verification
- [ ] Run `pnpm --filter @devs/core test:ci` and assert exit code is `0`.
- [ ] Validate metadata fields in the integration test output: assert every queried row has `thread_id != ''`, `task_id != ''`, `turn_index >= 0`.
- [ ] Confirm Git resolution is exercised by running `grep -rn "resolveGitCommitHash" packages/core/src/flight-recorder/` and asserting both `metadataResolver.ts` (definition) and `saopPersistence.ts` or its callers (usage) are present.
