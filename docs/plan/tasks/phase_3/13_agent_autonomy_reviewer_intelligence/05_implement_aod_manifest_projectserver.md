# Task: Implement Agent-Oriented Documentation (AOD) Manifest for ProjectServer (Sub-Epic: 13_Agent Autonomy & Reviewer Intelligence)

## Covered Requirements
- [3_MCP-REQ-MET-008]

## 1. Initial Test Written

- [ ] In `packages/core/src/mcp/__tests__/aod-manifest.test.ts`, write the following tests before any implementation:
  - **Unit: Manifest generation — tool entries** — Call `generateAODManifest({ tools: [{ name: "inspect_state", description: "Reads internal memory", inputSchema: {...}, outputSchema: {...} }] })`. Assert the returned Markdown string contains a `## inspect_state` heading, the description text, and a fenced JSON block for both `inputSchema` and `outputSchema`.
  - **Unit: Manifest generation — multiple tools** — Pass an array of 5 tools. Assert the output contains exactly 5 `## ` headings, one per tool.
  - **Unit: Manifest generation — introspection point tag** — Pass a tool with `tags: ["introspection_point"]`. Assert the output contains `**Tag**: introspection_point` in that tool's section.
  - **Unit: Manifest file write** — Call `persistAODManifest(manifest_string, { output_path: "/tmp/test/.agent/index.agent.md" })`. Assert the file is created at the path with the exact content.
  - **Unit: Manifest file overwrite** — Call `persistAODManifest` twice with different content. Assert the second call overwrites the file completely (no stale content remains).
  - **Unit: `list_tools` filtered by tags** — Given a `ProjectServer` with 3 tools (2 tagged `introspection_point`, 1 tagged `profiling`), call `listTools({ tags: ["introspection_point"] })`. Assert only the 2 tagged tools are returned.
  - **Integration: Auto-manifest on server start** — Start a mock `ProjectServer` instance. Assert that within the startup sequence, `generateAODManifest` is called and `persistAODManifest` writes `.agent/index.agent.md` to the project root.
  - **Integration: `checkAgenticObservability` reads the manifest** — The audit function from Task 03 reads `.agent/index.agent.md` to verify that any modified source module has a registered introspection point. Mock the manifest to include `src/foo.ts` → `inspect_state`. Assert a diff touching `src/foo.ts` passes the `checkAgenticObservability` dimension.

## 2. Task Implementation

- [ ] Create `packages/core/src/mcp/aod-manifest.ts`:
  - Define `AODToolEntry`:
    ```typescript
    interface AODToolEntry {
      name: string;
      description: string;
      inputSchema: object;
      outputSchema: object;
      tags?: string[];
      module?: string; // e.g., "src/foo.ts"
    }
    ```
  - Implement `generateAODManifest(input: { tools: AODToolEntry[] }): string`:
    - Produce a Markdown document with:
      - A top-level `# Agent Tool Index (index.agent.md)` heading.
      - A `> Auto-generated by ProjectServer on startup. Do not edit manually.` callout.
      - For each tool:
        - `## <tool_name>` heading.
        - `**Description**: <description>`.
        - If `tags` is present: `**Tags**: <tag1>, <tag2>`.
        - If `module` is present: `**Module**: <module>`.
        - A `### Input Schema` section with a fenced JSON code block containing `JSON.stringify(inputSchema, null, 2)`.
        - A `### Output Schema` section with a fenced JSON code block containing `JSON.stringify(outputSchema, null, 2)`.
  - Implement `persistAODManifest(markdown: string, opts: { output_path: string }): Promise<void>`:
    - Ensure the parent directory exists (create with `fs.mkdir` recursively).
    - Write the file with `fs.writeFile` (overwrite mode).
- [ ] Modify `packages/core/src/mcp/project-server.ts` (or the `ProjectServer` class):
  - Add a `registerTool(entry: AODToolEntry): void` method that adds the tool to an internal `tools: AODToolEntry[]` registry.
  - In the `start()` lifecycle method, after all tools are registered, call `generateAODManifest({ tools: this.tools })` then `persistAODManifest(manifest, { output_path: path.join(this.projectRoot, ".agent/index.agent.md") })`.
  - All five built-in tools (`inspect_state`, `run_test_task`, `db_bridge`, `capture_trace`, `get_logs`) MUST be registered with the `registerTool` method and tagged `introspection_point` or `profiling` as appropriate.
- [ ] Update `checkAgenticObservability` in `packages/core/src/agents/reviewer-audit.ts` to also read `.agent/index.agent.md` and verify that any modified source module is listed in the manifest's `**Module**: <module>` entries.

## 3. Code Review

- [ ] Verify the manifest is fully regenerated (not incrementally appended) on every call to `persistAODManifest` — stale tool entries MUST NOT persist between restarts.
- [ ] Verify `registerTool` is called before `start()` completes — if a tool is registered after `start()`, the manifest on disk will be stale. Document this contract in the JSDoc for `registerTool`.
- [ ] Verify the output directory creation in `persistAODManifest` is idempotent (`fs.mkdir` with `{ recursive: true }`).
- [ ] Confirm all five `ProjectServer` tools include non-empty `inputSchema` and `outputSchema` definitions — the audit from Task 03 depends on these schemas being present.
- [ ] Confirm the `module` field is populated for each tool so `checkAgenticObservability` can map source files to introspection points.

## 4. Run Automated Tests to Verify

- [ ] Run: `cd packages/core && npm test -- --testPathPattern="aod-manifest"` and confirm all tests pass.
- [ ] Run: `npm run lint && npx tsc --noEmit` in `packages/core` and confirm zero errors.
- [ ] Run the full suite: `npm test` from the monorepo root to confirm no regressions.

## 5. Update Documentation

- [ ] The `persistAODManifest` function already writes `.agent/index.agent.md` — update its JSDoc to note it is the canonical source of truth for agent introspection points.
- [ ] Update `docs/project-server.md` (create if absent) with a section "Agent-Oriented Documentation (AOD)" explaining:
  - The purpose of `.agent/index.agent.md`.
  - The auto-generation lifecycle (triggered on `ProjectServer.start()`).
  - How to add a new introspection point by calling `registerTool` with the correct `module` and `tags` fields.
- [ ] Update `.agent/index.agent.md` itself (at the `devs` project root, not the generated project root) to register `generateAODManifest` and `persistAODManifest` as tools available for agent introspection during development.

## 6. Automated Verification

- [ ] Run `node scripts/verify-requirements.js --req 3_MCP-REQ-MET-008` and confirm the script reports `COVERED` by detecting `generateAODManifest`, `persistAODManifest`, and the `start()` call chain in `project-server.ts`.
- [ ] After running the integration test that starts a `ProjectServer`, assert the file `.agent/index.agent.md` exists on disk and contains entries for all five built-in tools by running: `node -e "const fs=require('fs'); const c=fs.readFileSync('/tmp/test-project/.agent/index.agent.md','utf8'); ['inspect_state','run_test_task','db_bridge','capture_trace','get_logs'].forEach(t=>{ if(!c.includes(t)) throw new Error('Missing: '+t); }); console.log('AOD manifest OK');"`.
