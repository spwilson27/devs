# Task: Implement SAST Integration for Generated Code (Sub-Epic: 10_Vulnerability and Dependency Scanning)

## Covered Requirements
- [8_RISKS-REQ-124]

## 1. Initial Test Written
- [ ] In `packages/orchestrator/src/security/__tests__/sastRunner.test.ts`, write unit tests for a new `SASTRunner` class:
  - Test that `run(projectPath: string, language: SupportedLanguage): Promise<SASTReport>` returns a structured `SASTReport` with fields: `{ findings: SASTFinding[], hasCritical: boolean, hasHigh: boolean, tool: string, rawOutput: string, timestamp: string }`.
  - Test that when `semgrep --json --config=auto <projectPath>` exits with code 0 and produces no findings, `hasCritical` and `hasHigh` are both `false`.
  - Test that when `semgrep` returns a JSON payload with a finding of `severity: 'ERROR'`, `hasCritical` is `true`.
  - Test that when `semgrep` returns a finding of `severity: 'WARNING'`, `hasHigh` is `true`.
  - Test that for TypeScript/JavaScript projects (`language: 'typescript' | 'javascript'`), the `--config=p/typescript` and `--config=p/security-audit` rulesets are passed to `semgrep`.
  - Test that for Python projects (`language: 'python'`), `--config=p/python` and `--config=p/bandit` are used.
  - Test that for projects where `semgrep` is not installed, the runner gracefully logs a warning and returns an empty report with `tool: 'semgrep (unavailable)'` rather than throwing.
  - Test that `SASTFinding` objects are correctly mapped from the semgrep JSON output, extracting `{ ruleId, severity, message, filePath, startLine, endLine }`.
  - Write an integration test that runs the real `semgrep` binary (if available in CI) against a known-vulnerable TypeScript snippet in a temp file and asserts at least one finding is returned.

## 2. Task Implementation
- [ ] Create `packages/orchestrator/src/security/sastRunner.ts`:
  - Define `SupportedLanguage` type: `'typescript' | 'javascript' | 'python' | 'rust' | 'go' | 'unknown'`.
  - Define `SASTFinding` interface: `{ ruleId: string; severity: 'critical' | 'high' | 'medium' | 'low' | 'info'; message: string; filePath: string; startLine: number; endLine: number; }`.
  - Define `SASTReport` interface: `{ findings: SASTFinding[]; hasCritical: boolean; hasHigh: boolean; tool: string; rawOutput: string; timestamp: string; }`.
  - Implement `async function detectLanguage(projectPath: string): Promise<SupportedLanguage>` — checks for `tsconfig.json` (TypeScript), `package.json` without tsconfig (JavaScript), `pyproject.toml`/`setup.py` (Python), `Cargo.toml` (Rust), `go.mod` (Go).
  - Implement `class SASTRunner`:
    - `async run(projectPath: string, language?: SupportedLanguage): Promise<SASTReport>` — auto-detects language if not provided, selects appropriate semgrep rulesets, spawns `semgrep --json --metrics=off --config=<ruleset> <projectPath>`, parses the JSON output.
    - Map semgrep severity levels to the canonical `SASTFinding.severity` type: semgrep `ERROR` → `critical`, `WARNING` → `high`, `INFO` → `medium`/`low`.
    - On `ENOENT` (semgrep not found): log a warning via the orchestrator logger and return an empty report with `tool: 'semgrep (unavailable)'`.
    - Enforce a 5-minute timeout on the semgrep process using `AbortController`.
  - Export a singleton `sastRunner` instance from the module.
- [ ] Integrate `SASTRunner.run()` into the TDD pipeline's Code Review step in `packages/orchestrator/src/pipeline/codeReviewStep.ts` (or equivalent). After each implementation task completes, call `sastRunner.run(sandboxProjectPath)`. If `report.hasCritical || report.hasHigh`, surface the findings in the code review output and flag the task for remediation.
- [ ] Create `packages/orchestrator/src/security/sastPolicyEvaluator.ts`:
  - Implement `evaluatePolicy(report: SASTReport, policy: SASTPolicy): SASTEvaluationResult` where `SASTPolicy` specifies thresholds (e.g., `{ blockOnCritical: true, blockOnHigh: true, maxFindings: number }`).
  - `SASTEvaluationResult`: `{ shouldBlock: boolean; reason: string | null; findings: SASTFinding[]; }`.
  - Read the policy from `.devs/sast-policy.json` if present; otherwise use defaults (`blockOnCritical: true, blockOnHigh: true`).
- [ ] Add `semgrep` to `docs/prerequisites.md` as an optional but strongly recommended prerequisite.
- [ ] Add a default `.devs/sast-policy.json` template to `packages/orchestrator/templates/sast-policy.json`.

## 3. Code Review
- [ ] Confirm that `semgrep` is invoked with `--metrics=off` to prevent telemetry data leaking project code to Semgrep's servers, satisfying data minimization policies.
- [ ] Verify that the semgrep process is spawned with a minimal `env` object (only `PATH`), preventing host secrets from leaking into the SAST process environment.
- [ ] Confirm that `SASTReport.rawOutput` is truncated to 64 KB before storage/logging to prevent unbounded memory usage on large projects.
- [ ] Verify that the `--config` rulesets used are sourced from the project's own `.semgrep/` directory if present, falling back to the built-in defaults (allowing project-level customization).
- [ ] Ensure `SASTRunner` is exported from `packages/orchestrator/src/security/index.ts`.
- [ ] Confirm test coverage ≥ 85% for `sastRunner.ts` and `sastPolicyEvaluator.ts`.

## 4. Run Automated Tests to Verify
- [ ] Run `pnpm --filter orchestrator test --testPathPattern=sastRunner` and confirm all tests pass.
- [ ] Run `pnpm --filter orchestrator test --testPathPattern=sastPolicyEvaluator` and confirm all tests pass.
- [ ] Run `pnpm --filter orchestrator test --coverage` and confirm coverage thresholds are met.
- [ ] Run the full test suite `pnpm test` and confirm no regressions.

## 5. Update Documentation
- [ ] Add a section to `docs/security.md` titled **"SAST Integration for Generated Code"** describing: supported languages, the semgrep rulesets used, the SAST policy configuration (`sast-policy.json`), and how findings surface in the code review step.
- [ ] Update `docs/prerequisites.md` to mention `semgrep` as an optional dependency with installation instructions (`pip install semgrep` or `brew install semgrep`).
- [ ] Add inline comment above `SASTRunner.run`: `// [8_RISKS-REQ-124]: SAST scan of generated code to mitigate insecure code pattern risks.`
- [ ] Document the `SASTFinding` and `SASTReport` types in `docs/api/security.md` (create if absent).

## 6. Automated Verification
- [ ] Run `pnpm --filter orchestrator test --testPathPattern=sastRunner --passWithNoTests=false` and assert exit code is `0`.
- [ ] Run `grep -r "8_RISKS-REQ-124" packages/orchestrator/src/security/sastRunner.ts` and confirm the requirement tag is present.
- [ ] Run `node -e "const p = require('./packages/orchestrator/templates/sast-policy.json'); console.log(p.blockOnCritical)"` and confirm it outputs `true`.
