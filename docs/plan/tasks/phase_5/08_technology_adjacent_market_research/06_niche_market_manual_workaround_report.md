# Task: Implement Niche Market & Manual Workaround Report Generator (Sub-Epic: 08_Technology & Adjacent Market Research)

## Covered Requirements
- [1_PRD-REQ-RES-004], [1_PRD-REQ-RES-005], [9_ROADMAP-REQ-RES-004]

## 1. Initial Test Written
- [ ] Create `tests/research/test_adjacent_market_report_generator.py`.
- [ ] Write a unit test `test_report_contains_adjacent_markets_section` that provides a fixture `AdjacentMarketResult` with 2 adjacent markets and asserts the output Markdown contains a `## Adjacent Markets` heading with a sub-section for each market.
- [ ] Write a unit test `test_report_contains_manual_workarounds_section` asserting the output Markdown contains a `## Manual Workarounds` section listing each workaround string as a bullet point.
- [ ] Write a unit test `test_each_adjacent_market_section_has_pros_cons_tradeoffs` asserting each market sub-section contains "Pros", "Cons", and "Trade-offs" headings (per requirement [1_PRD-REQ-MAP-003]).
- [ ] Write a unit test `test_each_adjacent_market_section_has_source_citations` asserting each market section contains a "Sources" sub-section with at least one `[source N](url)` hyperlink.
- [ ] Write a unit test `test_report_contains_relevance_scores` asserting each adjacent market sub-section includes the `relevance_score` value in a human-readable format (e.g., "**Relevance:** 0.82").
- [ ] Write a unit test `test_report_contains_opportunity_summary` asserting the report ends with an `## Opportunity Summary` section containing LLM-generated text synthesizing the adjacent markets and workarounds into a strategic recommendation.
- [ ] Write a unit test `test_report_skipped_when_result_is_none` asserting the generator returns `None` (or an empty string) when given a `None` `AdjacentMarketResult`, without calling the LLM.
- [ ] All tests must initially FAIL (red phase).

## 2. Task Implementation
- [ ] Create `src/research/reports/adjacent_market_report_generator.py`.
- [ ] Implement `AdjacentMarketReportGenerator` class with:
  - `__init__(self, llm_client)`.
  - `generate(self, result: AdjacentMarketResult | None) -> str | None`: Returns `None` if `result` is `None`. Otherwise returns a complete Markdown document string.
- [ ] Report structure:
  1. `# Adjacent Market & Niche Research Report` (title + metadata: timestamp, niche trigger reason from `NicheDetectionResult.reason` if available).
  2. `## Adjacent Markets` — one `###` subsection per `AdjacentMarket` with: **Relevance Score**, Description, Pros, Cons, Trade-offs, Sources.
  3. `## Manual Workarounds` — a bulleted list of each `manual_workaround` string with a brief LLM-generated explanation of why users resort to this workaround.
  4. `## Opportunity Summary` — LLM-generated synthesis (2–3 paragraphs) identifying the most promising adjacent market or workaround pattern to inform architectural decisions.
- [ ] Pros/Cons/Trade-offs for each adjacent market must be generated by an LLM call using the market's description and `relevance_score` as context.
- [ ] Write the final report to `output/research/adjacent_market_report.md` via the shared `ReportWriter` utility (`src/research/utils/report_writer.py`).
- [ ] Create `src/research/reports/adjacent_market_report_generator.agent.md`.

## 3. Code Review
- [ ] Verify the `None` short-circuit is the first check in `generate()`.
- [ ] Verify Pros/Cons/Trade-offs generation uses the same LLM prompt pattern as the tech landscape report (consistency across report generators).
- [ ] Verify the `## Opportunity Summary` LLM call receives a consolidated context (all adjacent markets + all workarounds) in a single prompt, not one call per market.
- [ ] Verify `ReportWriter` is shared from `src/research/utils/report_writer.py` and not duplicated in this module.
- [ ] Verify source URLs are sanitized before rendering as Markdown hyperlinks.
- [ ] Confirm all public methods are typed.

## 4. Run Automated Tests to Verify
- [ ] Run `pytest tests/research/test_adjacent_market_report_generator.py -v` and confirm all tests pass.
- [ ] Run `pytest --cov=src/research/reports/adjacent_market_report_generator --cov-report=term-missing` and confirm line coverage ≥ 90%.

## 5. Update Documentation
- [ ] Update `src/research/reports/adjacent_market_report_generator.agent.md` with the full report schema, the `None` short-circuit behavior, and a note on the Opportunity Summary LLM prompt.
- [ ] Add example output to `docs/examples/adjacent_market_report_sample.md`.
- [ ] Update `docs/architecture/research_agents.md` with an `AdjacentMarketReportGenerator` entry.
- [ ] Update `CHANGELOG.md`.

## 6. Automated Verification
- [ ] Run `pytest tests/research/test_adjacent_market_report_generator.py --tb=short` and assert exit code is `0`.
- [ ] Run the generator against the fixture data: `python -m src.research.reports.adjacent_market_report_generator --fixture` and assert `output/research/adjacent_market_report.md` is created and contains `# Adjacent Market & Niche Research Report`.
- [ ] Run `python scripts/verify_aod_density.py src/research/reports/` to confirm 1:1 `.py`/`.agent.md` ratio.
