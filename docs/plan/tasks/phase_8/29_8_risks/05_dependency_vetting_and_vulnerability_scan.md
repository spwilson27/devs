# Task: Dependency Vetting & Vulnerability Scan (Sub-Epic: 29_8_RISKS)

## Covered Requirements
- [8_RISKS-REQ-131]

## 1. Initial Test Written
- [ ] Create an integration test at tests/ci/dependency-scan.spec.ts that runs the dependency scan script against a fixture `tests/fixtures/vuln-package.json` (a small package.json with a known vulnerable package). The test must assert the script exits with a non-zero status and prints the vulnerability summary to stdout in JSON.

## 2. Task Implementation
- [ ] Add `scripts/dependency-scan.sh` which:
  - Runs `npm ci --package-lock-only` (or `yarn install --frozen-lockfile`) for the fixture in a sandboxed temp directory.
  - Runs `npm audit --json` and parses the JSON output to fail the script when the audit lists high/critical vulnerabilities.
  - Returns exit code 1 when policy violations are found; supports `--fail-threshold` CLI flag.
- [ ] Add a small Node helper `scripts/parse-audit.js` that normalizes audit output into a concise vulnerability report.
- [ ] Add an npm script `npm run ci:dependency-scan` that CI pipelines can call.

## 3. Code Review
- [ ] Ensure the scanning script runs in a sandboxed temporary directory and never mutates the repository working tree.
- [ ] Confirm the parser does not leak sensitive environment variables into logs.
- [ ] Ensure error messages are machine-readable JSON when run with `--json` and human-readable otherwise.

## 4. Run Automated Tests to Verify
- [ ] Run `npm run ci:dependency-scan` against the `tests/fixtures/vuln-package.json` sandbox and assert non-zero exit on vulnerabilities.
- [ ] Verify the script succeeds on a fixture with no known vulnerabilities.

## 5. Update Documentation
- [ ] Add `docs/risks/dependency-vetting.md` describing the scan, how to add exceptions, and how to interpret results.

## 6. Automated Verification
- [ ] Add a CI job `dependency-scan` in the repository's pipeline that runs `npm run ci:dependency-scan` for every PR and on main branch pushes.
- [ ] Log results to the CI artifacts as a JSON vulnerability report for auditing.
