# State Sharing Architecture

## Overview

The `devs` system uses a single shared SQLite database — the **Flight Recorder** — to maintain real-time state across all components (CLI, VSCode Extension, MCP server). This document explains how the CLI and VSCode extension share state through the `.devs/` directory.

## The `.devs/` Flight Recorder Directory

The `.devs/` directory lives at the project root and contains all runtime state generated by the `devs` system:

```
<project-root>/
└── .devs/
    ├── .gitignore       # Excludes all runtime files from VCS
    ├── POLICY.md        # Developer Agent write-access prohibition policy
    └── state.sqlite     # Shared SQLite state database (runtime, not committed)
```

Runtime files (`.sqlite`, `.lance/`, `.log`) are excluded from version control by `.devs/.gitignore`. Only `POLICY.md` and `.gitignore` itself are tracked.

## Shared State File Path

The canonical path to the shared state database is defined as a constant in `@devs/core`:

```typescript
// packages/core/src/constants.ts
export const STATE_FILE_PATH = ".devs/state.sqlite" as const;
```

This constant is the **single source of truth** for the state file location. All packages that need to access the state file MUST import this constant from `@devs/core` — they must never hardcode the path.

## How CLI and VSCode Extension Access Shared State

Both the CLI and the VSCode extension depend on `@devs/core` as a workspace dependency:

```json
// packages/cli/package.json  AND  packages/vscode/package.json
{
  "dependencies": {
    "@devs/core": "workspace:*"
  }
}
```

This means both packages resolve the state path through the same module:

```
packages/cli        →  @devs/core/persistence  →  resolveStatePath()  →  /abs/path/.devs/state.sqlite
packages/vscode     →  @devs/core/persistence  →  resolveStatePath()  →  /abs/path/.devs/state.sqlite
```

Because both packages use the same resolver function in the same `@devs/core` module, they always arrive at the same absolute path — guaranteeing state consistency.

## Path Resolution Strategy

The `resolveStatePath()` function in `@devs/core/persistence` uses a root-walking strategy:

1. Start from the caller's current working directory (or an explicit `fromDir` parameter).
2. Walk up the directory tree, checking each directory for a `package.json` with `"private": true`.
3. When found, that directory is the project root.
4. Return `resolve(root, ".devs/state.sqlite")`.

```typescript
// packages/core/src/persistence.ts
import { resolveStatePath } from "@devs/core/persistence";

// Works correctly from any subdirectory:
const stateFile = resolveStatePath();           // from process.cwd()
const stateFile = resolveStatePath("/path/to/packages/cli");  // explicit dir
```

This approach is robust regardless of which package or subdirectory the caller is operating in.

## Access Control Policy

Per `.devs/POLICY.md`:

- **`@devs/core` and `@devs/memory`** manage all reads and writes to `.devs/state.sqlite`.
- **Developer Agents** (AI code generators) have **NO write access** to `.devs/`.
- This prevents AI agents from tampering with task state, loop counters, or audit trails.

The CLI and VSCode extension pass all state queries through `@devs/core` APIs — they never open the SQLite database directly.

## Database Connection Manager

The `createDatabase()` factory in `packages/core/src/persistence/database.ts`
opens and configures the SQLite connection:

```typescript
import { createDatabase, getDatabase, closeDatabase } from "@devs/core/persistence/database";

// Create a new database instance (typically done once at startup)
const db = createDatabase();           // uses project-root auto-resolution
const db = createDatabase({ dbPath: "/abs/path/.devs/state.sqlite" });  // explicit path

// Singleton pattern for long-running processes
const db = getDatabase();              // returns the same instance each call
closeDatabase();                       // disposes the singleton (for testing/shutdown)
```

PRAGMA settings applied at initialisation:

| PRAGMA | Value | Reason |
|---|---|---|
| `journal_mode` | `WAL` | Concurrent reads + writes for CLI and VSCode Extension |
| `synchronous` | `NORMAL` (1) | Flush at critical checkpoints; avoids excessive `fsync` calls |

The `.devs/` directory is created automatically by `ensureDirSync` if it does not exist.

## Requirements Satisfied

| Requirement | Description |
|---|---|
| `1_PRD-REQ-INT-013` | Real-time state sharing between CLI and VSCode extension enabled by consistent `STATE_FILE_PATH` constant and shared resolver. |
| `TAS-076` | Version manifest initialized in root `package.json` under the `devs` metadata field. |
| `TAS-066` | Persistence layer initialised with better-sqlite3, WAL mode, NORMAL synchronous. |
| `TAS-010` | `better-sqlite3` used as the SQLite library (zero-dependency, synchronous API). |
| `4_USER_FEATURES-REQ-086` | No external cloud dependencies; all state stored locally in `.devs/state.sqlite`. |

## Diagram

```mermaid
graph TD
    CLI["@devs/cli<br/>(UI shell)"]
    VSCODE["@devs/vscode<br/>(UI shell)"]
    CORE["@devs/core<br/>(business logic)"]
    PERSISTENCE["persistence.ts<br/>resolveStatePath()"]
    CONSTANTS["constants.ts<br/>STATE_FILE_PATH"]
    SQLITE[".devs/state.sqlite<br/>(SQLite Flight Recorder)"]

    CLI -->|"depends on workspace:*"| CORE
    VSCODE -->|"depends on workspace:*"| CORE
    CORE --> PERSISTENCE
    PERSISTENCE --> CONSTANTS
    CORE --> DATABASE
    DATABASE["persistence/database.ts<br/>createDatabase() / getDatabase()"]
    DATABASE -->|"opens + configures<br/>(WAL, NORMAL)"| SQLITE
```
